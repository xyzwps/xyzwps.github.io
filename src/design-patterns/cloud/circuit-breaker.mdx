---
title: Circuit Breaker Pattern
translateFrom: https://docs.microsoft.com/en-us/azure/architecture/patterns/circuit-breaker
---

在连接到远程服务或资源时, 处理可能需要花费不同时间恢复的错误。这可以提高应用程序的稳定性和弹性。

# 问题背景

在分布式环境中，对远程资源和服务的调用可能由于暂时性故障而失败，
例如网络连接速度缓慢、超时或资源超量使用或暂时不可用。
这些错误通常会在短时间内自我纠正，一个健壮的云应用程序应该准备好通过使用诸如
Retry 模式（TODO: 链接到重试模式）之类的策略来处理这些错误。

但是，也可能出现由于意外事件而导致错误的情况，这可能需要更长的时间来修复。
这些故障的严重程度可以从连接的部分丧失到服务的完全失败。
在这些情况下，应用程序不断重试不太可能成功的操作可能是没有意义的，
相反，应用程序应该迅速接受操作失败并相应地处理这种失败。

此外，如果服务非常繁忙，系统某个部分的故障可能会导致级联故障。
例如，可以将调用服务的操作配置为实现超时，并在服务未能在此期间响应时使用失败消息进行响应。
但是，这种策略可能导致对同一操作的许多并发请求被阻塞，直到超时期满。
这些被阻塞的请求可能包含关键的系统资源，如内存、线程、数据库连接等。
因此，这些资源可能会耗尽，导致系统中需要使用相同资源的其他可能不相关的部分出现故障。
在这些情况下，最好是操作立即失败，并且只有在可能成功的情况下才尝试调用服务。
请注意，设置较短的超时时间可能有助于解决这个问题，但是超时时间不应该太短，
以至于大多数情况下操作都会失败，即使对服务的请求最终会成功。

# 解决方案

断路器模式，由迈克尔奈加德在他的书 [Release It!](https://pragprog.com/titles/mnee2/release-it-second-edition/) 中推广，
可以防止应用程序重复尝试执行可能失败的操作。
允许它继续运行，而不需要等待故障被修复或浪费 CPU 周期，同时它确定故障是长期持续的。
断路器模式还使应用程序能够检测故障是否已得到解决。
如果问题看起来已经修复，应用程序可以尝试调用该操作。

> 断路器模式的用途不同于重试模式。
> Retry 模式使应用程序能够在预期操作成功的情况下重试操作。
> 断路器模式防止应用程序执行可能失败的操作。
> 应用程序可以通过使用 Retry 模式通过断路器调用操作来组合这两种模式。
> 然而，重试逻辑应该对断路器返回的任何异常敏感，如果断路器表明故障不是暂态的，则放弃重试尝试。

断路器充当可能失败的操作的代理。代理应该监视最近发生的故障数量，
并使用此信息来决定是允许继续操作，还是仅仅立即返回异常。

该代理可以作为状态机实现，具有下列状态，模拟电气断路器的功能:

* **Closed**: 来自应用程序的请求被路由到操作。
  代理维护最近失败次数的计数，如果对操作的调用不成功，代理将增加这个计数。
  如果在给定的时间段内最近的故障数量超过指定的阈值，则代理将处于 Open 状态。
  此时，代理启动一个超时计时器，当该计时器过期时，代理将被放置到 Half-Open。
  > 超时计时器的作用是在允许应用程序再次尝试执行操作之前，给系统时间来修复导致故障的问题。
* **Open**: 来自应用程序的请求立即失败，并向应用程序返回异常。
* **Half-Open**: 允许来自应用程序的有限数量的请求通过和调用操作。
  如果这些请求成功，则假定以前导致故障的故障已经修复，断路器切换到关闭状态(故障计数器重置)。
  如果任何请求失败，断路器假定故障仍然存在，因此它将恢复到 Open 状态并重新启动超时计时器，
  以便给系统更长的时间从故障中恢复。
  > Half-Open 状态有助于防止正在恢复的服务突然被大量请求淹没。
  > 随着服务的恢复，它可能能够支持有限数量的请求，直到恢复完成，但是当恢复正在进行时，
  > 大量的工作可能导致服务超时或再次失败。

![circuit breaker diagram](/asset/img/circuit-breaker-diagram.png)

在图中，闭合状态使用的故障计数器是基于时间的。
每隔一段时间就会自动重置。这有助于防止断路器进入开启状态，如果它经历偶然的故障。
只有在特定间隔内发生特定数量的故障时，才能达到使断路器进入开启状态的故障阈值。
Half-Open 状态使用的计数器记录成功调用操作的次数。
断路器在连续调用指定数量的操作成功后恢复到关闭状态。
如果任何调用失败，断路器立即进入开放状态，成功计数器将在下次进入 Half-Open 时重置。

> 系统如何恢复由外部处理，可能是通过恢复或重新启动失败的组件或修复网络连接。

断路器模式在系统从故障中恢复时提供稳定性，并将对性能的影响降至最低。
通过快速拒绝可能失败的操作请求，而不是等待操作超时或永远不返回，它可以帮助维护系统的响应时间。
如果断路器每次更改状态时都会引发一个事件，则此信息可用于监视受断路器保护的系统部分的健康状况，
或者当断路器进入打开状态时向管理员发出警报。

该模式是可定制的，并且可以根据可能的故障类型进行调整。
例如，可以对断路器应用增加的超时计时器。您可以首先将断路器置于 Open 状态几秒钟，
然后如果故障尚未解决，则将超时时间增加到几分钟，以此类推。
在某些情况下，与 Open 状态返回失败并引发异常不同，返回对应用程序有意义的默认值可能是有用的。

# 问题与注意事项

在决定如何实现此模式时，应考虑以下几点:

**异常处理**。通过断路器调用操作的应用程序必须准备好处理操作不可用时引起的异常。
异常的处理方式将是特定于应用程序的。例如，应用程序可能会暂时降低其功能，
调用替代操作来尝试执行相同的任务或获取相同的数据，或者向用户报告异常并要求他们稍后再试。

**异常类型**。请求可能由于许多原因而失败，其中一些原因可能表明了比其他原因更严重的失败类型。
例如，请求可能会失败，因为远程服务已经崩溃，需要几分钟才能恢复，或者由于服务暂时超载导致超时。
断路器可以检查发生的异常类型，并根据这些异常的性质调整策略。
例如，与由于服务完全不可用而导致的故障数量相比，可能需要更多的超时异常才能使断路器断开至打开状态。

**日志**。断路器应该记录所有失败的请求(以及可能成功的请求) ，以使管理员能够监视操作的健康状况。

**可恢复性**。你应该配置断路器来匹配它所保护的操作的可能恢复模式。
例如，如果断路器长时间处于开启状态，即使故障原因已得到解决，也可能产生例外情况。
同样，如果断路器过快地从“开放状态”切换到“ Half-Open 状态”，那么断路器可能会出现波动，
从而减少应用程序的响应时间。

**测试失败的操作**。在开放状态下，断路器不用定时器来决定什么时候切换到 Half-Open，
而是可以周期性地向远程服务或资源发送 ping 信号，以确定它是否再次可用。
此 ping 可以采取尝试调用以前失败的操作的形式，
也可以使用远程服务提供的专门用于测试服务健康状况的特殊操作，
正如 Health Endpoint Monitor 模式（TODO: 链接到此模式）所描述的那样。

**手动重写**。在一个故障操作的恢复时间非常可变的系统中，最好提供一个手动复位选项，
使管理员能够关闭断路器(并复位故障计数器)。类似地，如果断路器保护的操作暂时不可用，
管理员可以强制断路器进入 Open 状态(并重新启动超时计时器)。

**并发性**。应用程序的大量并发实例可以访问相同的断路器。
这个实现不应该阻止并发请求，也不应该给每个对操作的调用增加额外的开销。

**资源区分**。如果可能有多个底层独立提供程序，那么在对一种资源使用单个断路器时要小心。
例如，在包含多个碎片的数据存储区中，一个碎片可能是完全可访问的，而另一个碎片出现了临时问题。
如果合并了这些场景中的错误响应，应用程序可能会尝试访问一些碎片，即使失败的可能性很高，
而访问其他碎片可能会被阻止，即使它可能会成功。

**加速断路**。有时，故障响应可以包含足够的信息，使断路器立即跳闸，并保持跳闸的最短时间。
例如，来自重载的共享资源的错误响应可能表明不建议立即重试，应用程序应该在几分钟内重试。

Note: 服务可以返回 HTTP 429(太多请求) ，如果它正在节流客户端，或 HTTP 503(服务不可用) ，
如果服务当前不可用。响应可以包括其他信息，例如延迟的预期持续时间。

**重播失败的请求**。在 Open 状态下，断路器不仅可以快速失败，还可以将每个请求的详细信息记录到日志中，
并安排在远程资源或服务可用时重播这些请求。

**外部服务的不适当超时**。断路器可能无法完全保护应用程序不受配置了较长超时时间的外部服务中出现故障的操作的影响。
如果超时时间过长，在断路器显示操作失败之前，运行断路器的线程可能会被阻塞一段较长的时间。
这时，许多其他应用程序实例也可能尝试通过断路器调用服务，并在线程全部失败之前占用大量线程。

# 何时使用

以下场景可以使用此模式：

* 如果此操作极有可能失败，则防止应用程序尝试调用远程服务或访问共享资源。

以下场景可能不适用：

* 用于处理对应用程序中的本地专用资源(如内存中的数据结构)的访问。在这种环境下，
  使用断路器会增加系统开销。
* 作为在应用程序的业务逻辑中处理异常的替代。
