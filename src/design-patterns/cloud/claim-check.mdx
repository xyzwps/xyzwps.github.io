---
title: Claim-Check Pattern
translateFrom: https://docs.microsoft.com/en-us/azure/architecture/patterns/claim-check
---


将大消息拆分为 claim check 和 payload。
将 claim check 发送到消息传递平台，并将 payload 存储到外部服务。
这种模式允许处理大型消息，同时保护消息总线和客户机不受到过载或减速的影响。
这种模式还有助于降低成本，因为存储通常比消息传递平台使用的资源单元更便宜。

这种模式也被称为基于参考的消息传递，最初由 Gregor Hohpe 和 Bobby Woolf 在
《企业集成模式》一书中[描述](https://www.enterpriseintegrationpatterns.com/patterns/messaging/StoreInLibrary.html)。

# 问题背景

基于消息传递的架构在某种程度上必须能够发送、接收和操作大型消息。
这样的消息可能包含任何内容，包括图像(例如 MRI 扫描)、声音文件(例如呼叫中心电话)、
文本文档或任意大小的任何类型的二进制数据。

不建议直接向消息总线发送如此大的消息，因为它们需要消耗更多的资源和带宽。
大消息还会降低整个解决方案的速度，因为消息传递平台通常会进行微调，以处理大量的小消息。
此外，大多数消息传递平台对消息大小都有限制，因此对于大型消息，可能需要绕过这些限制。

# 解决方案

将整个消息 payload 存储到外部服务(如数据库)中。
获取对存储的 payload 的引用，并将该引用发送到消息总线。
该参考行为类似于用于检索行李的索赔支票，因此该模式的名称就是。
如果需要，对处理特定消息感兴趣的客户机可以使用获得的引用来检索有效负载。

![check claim](/asset/img/claim-check.png)

# 问题与注意事项

在决定如何实现此模式时，请考虑以下几点:

* 如果不需要对消息进行归档，可以考虑在使用消息数据之后删除它。
  尽管 blob 存储相对便宜，但是从长远来看，尤其是在存储大量数据的情况下，它需要花费一些钱。
  删除消息可以由接收和处理消息的应用程序同步完成，也可以由单独的专用进程异步完成。
  异步方法在不影响接收应用程序的吞吐量和消息处理性能的情况下删除旧数据。
* 存储和检索消息会导致一些额外的开销和延迟。
  您可能希望在发送应用程序中实现逻辑，以便仅当消息大小超过消息总线的数据限制时才使用此模式。
  对于较小的消息，将跳过该模式。这种方法将导致条件索赔检查模式。

# 何时使用

当消息不能满足所选消息总线技术支持的消息限制时，可以使用此模式。
例如，服务总线目前的限制是100MB (溢价层（premium tier）) ，而事件网格支持最多1MB 的消息。

如果有效负载只能被授权查看它的服务访问，那么也可以使用该模式。
通过将有效负载卸载到外部资源，可以实施更严格的身份验证和授权规则，
以确保在有效负载中存储敏感数据时执行安全性。