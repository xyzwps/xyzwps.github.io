---
title: Compute Resource Consolidation Pattern
translateFrom: https://docs.microsoft.com/en-us/azure/architecture/patterns/compute-resource-consolidation
---

将多个任务或操作合并为一个计算单元。
这可以提高计算资源的利用率，并减少与在云托管应用程序中执行计算处理相关的成本和管理开销。

# 问题背景

云应用程序通常实现各种操作。
在一些解决方案中，最初遵循关注点分离的设计原则，并将这些操作划分为单独的计算单元，
分别托管和部署(例如，作为单独的应用服务网络应用程序或单独的虚拟机)。
然而，尽管这种策略可以帮助简化解决方案的逻辑设计，
但是作为同一应用程序的一部分部署大量计算单元可能会增加运行时托管成本，并使系统管理更加复杂。

作为一个示例，该图显示了使用多个计算单元实现的云托管解决方案的简化结构。
每个计算单元在其自己的虚拟环境中运行。
每个函数都被实现为一个单独的任务(标签为 TaskA 到 TaskE) ，在它自己的计算单元中运行。

![compute-resource-consolidation-diagram](/asset/img/compute-resource-consolidation-diagram.png)

每个计算单元消耗可收费的资源，即使它是空闲的或使用不多。因此，这并不总是最具成本效益的解决方案。

在 Azure 中，这个问题适用于应用程序服务、容器应用程序和虚拟机。
这些项目在它们自己的环境中运行。
运行一组单独的网站、微服务或虚拟机，这些网站、微服务或虚拟机被设计用于执行一组定义良好的操作，
但是需要作为单个解决方案的一部分进行通信和合作，这可能是对资源的低效利用。

# 解决方案

为了帮助降低成本，提高利用率，提高通信速度，并减少管理，将多个任务或操作合并到一个单一的计算单元是可能的。

根据环境提供的特性和与这些特性相关的成本，可以根据标准对任务进行分组。
一种常见的方法是查找与其可伸缩性、生命周期和处理需求相似的任务。
将这些组合在一起可以使它们作为一个单元进行扩展。
许多云环境提供的灵活性允许根据工作负载启动和停止额外的计算单元实例。
例如，Azure 提供了自动 scaling 功能，您可以将其应用到 App Services 和 Virtual Machine Scale Set。
有关更多信息，请参见[自动scaling指南](https://docs.microsoft.com/en-us/previous-versions/msp-n-p/dn589774(v=pandp.10))。

作为一个反例来说明如何使用可伸缩性来确定哪些操作不应该组合在一起，请考虑以下两个任务:

* Task 1 轮询发送到队列的不常见、时间不敏感的消息。
* Task 2 处理高容量的网络流量爆发。

第二个任务需要弹性，包括启动和停止大量计算单元的数量。
对第一个任务应用相同的扩展只会导致更多的任务侦听同一队列上不常见的消息，这是一种资源浪费。

在许多云环境中，可以根据 CPU 核心数量、内存、磁盘空间等指定可用于计算单元的资源。
一般来说，指定的资源越多，成本就越高。
为了节省资金，最大化昂贵的计算单元所执行的工作是非常重要的，不要让它长时间处于不活跃状态。

如果有一些任务在短时间内需要大量的 CPU 能力，那么考虑将这些任务合并到一个单独的计算单元中，
以提供必要的能力。然而，在保持昂贵资源忙碌的需求与过度紧张时可能发生的争用之间取得平衡是很重要的。
例如，长时间运行的计算密集型任务不应该共享相同的计算单元。

# 问题与注意事项

在实现此模式时，请考虑以下几点:

**可伸缩性和弹性**。许多云解决方案通过启动和停止单元的实例，在计算单元级别实现可伸缩性和弹性。
避免在同一计算单元中对具有冲突的可伸缩性需求的任务进行分组。

**Lifetime**。云基础设施周期性地回收承载计算单元的虚拟环境。
当一个计算单元中有许多长时间运行的任务时，可能需要对该单元进行配置，以防止它在这些任务完成之前被回收。
或者，通过使用检查点方法设计任务，该方法使任务能够干净地停止，并在计算单元重新启动时中断任务时继续执行。

**Release cadence**。如果任务的实现或配置频繁更改，则可能需要停止承载更新代码的计算单元，
重新配置和重新部署该单元，然后重新启动它。
这个过程还需要停止、重新部署和重新启动同一计算单元内的所有其他任务。

**Security**。同一计算单元中的任务可能共享相同的安全上下文，并能够访问相同的资源。
任务之间必须有高度的信任，并且相信一个任务不会损坏或对另一个任务产生负面影响。
此外，增加计算单元中运行的任务数量会增加单元的攻击面。每个任务的安全性都取决于最易受攻击的任务。

**容错**。如果一个计算单元中的一个任务失败或表现异常，它可能会影响在同一个单元中运行的其他任务。
例如，如果一个任务无法正确启动，它可能导致计算单元的整个启动逻辑失败，并阻止同一单元中的其他任务运行。

**竞争**。避免在争夺同一计算单元资源的任务之间引入争用。
理想情况下，共享相同计算单元的任务应该表现出不同的资源利用特征。
例如，两个计算密集型任务可能不应该驻留在同一个计算单元中，两个消耗大量内存的任务也不应该驻留在同一个计算单元中。
然而，将计算密集型任务与需要大量内存的任务混合在一起是可行的组合。

Note: 考虑只为生产了一段时间的系统整合计算资源，这样操作员和开发人员就可以监视系统，
并创建一个热图来标识每个任务如何使用不同的资源。此映射可用于确定哪些任务适合共享计算资源。

**复杂性**。将多个任务组合到单个计算单元中会增加单元中代码的复杂性，可能会使测试、调试和维护变得更加困难。

**稳定的逻辑架构**。设计并实现每个任务中的代码，这样即使任务运行所在的物理环境发生了更改，代码也不需要更改。

**其他策略**。合并计算资源只是帮助降低与同时运行多个任务相关的成本的一种方法。
它需要认真的规划和监测，以确保它仍然是一个有效的办法。其他策略可能更合适，这
取决于工作的性质以及这些任务运行的用户所在的位置
。例如，工作负载的功能分解(正如[计算分区指南](https://docs.microsoft.com/en-us/previous-versions/msp-n-p/dn589773(v=pandp.10))所描述的)可能是一个更好的选择。

# 何时使用

如果任务在其自己的计算单元中运行，则对其成本效益不高的任务使用此模式。
如果一个任务大部分时间处于空闲状态，那么在一个专门的单元中运行这个任务可能会非常昂贵。

此模式可能不适合执行关键容错操作的任务，或处理高度敏感或私有数据并需要自己的安全上下文的任务。
这些任务应该在它们自己的独立环境中，在一个单独的计算单元中运行。

# 应用平台选择

这种模式可以通过不同的方式实现，具体取决于您使用的计算服务:

* **Azure 应用程序服务**和 **Azure 函数**: 部署共享应用程序服务计划，这些计划代表托管服务器基础设施。
  可以将一个或多个应用程序配置为在相同的计算资源上运行(或在相同的应用程序服务计划中)。
* **Azure Container Apps**: 将容器应用程序部署到相同的共享环境; 
  特别是在需要管理相关服务或需要将不同的应用程序部署到同一个虚拟网络的情况下。
* **Azure Kubernetes Service (AKS) **: AKS 是一种基于容器的托管基础设施，
  其中多个应用程序或应用程序组件可以配置为在同一计算资源(节点)上运行，
  并根据计算需求(如 CPU 或内存需求(节点池))进行分组。
* **虚拟机**: 部署一组供所有租户使用的虚拟机，这样管理成本在租户之间共享。
  虚拟机缩放集是一个支持共享资源管理、负载平衡和虚拟机水平缩放的特性。