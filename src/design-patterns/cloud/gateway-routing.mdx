---
title: 网关路由
translateFrom: https://docs.microsoft.com/en-us/azure/architecture/patterns/gateway-routing
---

使用单个端点将请求路由到多个服务。
当您希望公开单个端点上的多个服务并根据请求将其路由到适当的服务时，此模式非常有用。

# 问题背景

当客户端需要使用多个服务时，为每个服务设置单独的端点并让客户端管理每个端点可能是一个挑战。
例如，电子商务应用程序可能提供诸如搜索、评论、购物车、结帐和订单历史等服务。
每个服务都有客户端必须与之交互的不同 API，客户端必须了解每个端点才能连接到服务。
如果 API 发生变化，客户端也必须进行更新。
如果将服务重构为两个或多个单独的服务，则代码必须在服务和客户端中都发生更改。

# 解决方案

将网关放在一组应用程序、服务或部署的前面。使用应用程序第7层路由将请求路由到适当的实例。

使用此模式，客户端应用程序只需了解单个端点并与之通信。
如果服务被合并或分解，则客户端不一定需要更新。
它可以继续向网关发出请求，并且只改变路由。

网关还允许您从客户端抽象后端服务，从而使客户端调用保持简单，
同时允许对网关后面的后端服务进行更改。
客户端调用可以路由到任何需要处理预期客户端行为的服务或服务，
从而允许您在网关后添加、分割和重新组织服务，而无需更改客户端。

![gateway-routing](/asset/img/gateway-routing.png)

通过允许您管理如何向用户推出更新，此模式还可以帮助进行部署。
部署服务的新版本时，可以将其与现有版本并行部署。
路由允许您控制向客户端提供的服务版本，使您可以灵活地使用各种发布策略，
无论是增量的、并行的还是完整的更新展示。
在部署新服务之后发现的任何问题都可以通过在网关上进行配置更改而迅速恢复，而不会影响客户机。

# 问题与注意事项

* 网关服务可能会引入单点故障。确保它的设计正确，以满足您的可用性需求。实现时请考虑弹性和容错能力。
* 网关服务可能会引入瓶颈。确保网关具有足够的性能来处理负载，并且可以很容易地按照您的增长预期进行扩展。
* 对网关执行负载测试，以确保不会为服务引入级联故障。
* 网关路由级别为7。它可以基于 IP、端口、头或 URL。

# 何时使用

在以下情况下使用这种模式:

* 客户端需要使用网关后面可以访问的多个服务。
* 您希望通过使用单个端点来简化客户端应用程序。
* 您需要将请求从外部可寻址的端点路由到内部虚拟端点，例如将 VM 上的端口公开到集群虚拟 IP 地址。

当您有一个只使用一个或两个服务的简单应用程序时，此模式可能不适合。

# 示例


使用 Nginx 作为路由器，下面是一个服务器的简单示例配置文件，
它将驻留在不同虚拟目录中的应用程序的请求路由到后端的不同机器。

```console
server {
    listen 80;
    server_name domain.com;

    location /app1 {
        proxy_pass http://10.0.3.10:80;
    }

    location /app2 {
        proxy_pass http://10.0.3.20:80;
    }

    location /app3 {
        proxy_pass http://10.0.3.30:80;
    }
}
```


