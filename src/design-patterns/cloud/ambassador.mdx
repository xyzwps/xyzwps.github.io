---
title: Ambassador Pattern
---

[戳此处查看原文](https://docs.microsoft.com/en-us/azure/architecture/patterns/ambassador)

创建帮助器服务，来代表使用者服务或应用程序发送网络请求。
可以将 ambassador 服务看作是与客户机同处一地的进程外代理。

这个模式常用于以语言无关的方式卸载常见的客户端连接的任务，
如监视、日志记录、路由、安全性(如 TLS)和弹性模式（TODO: 链接到弹性模式）。
它通常与遗留的应用程序或难以修改的其他应用程序一起使用，
以扩展其网络功能。它还可以使专门的团队实现这些特性。

# 问题背景

基于弹性云的应用程序需要诸如断路（TODO: 链接到断路模式）、路由、计量和监控等功能，
以及更新网络相关配置的能力。
要更新遗留的应用程序或现有的代码库来添加这些特性可能很困难或不可能，
因为代码不再被维护，或者不能被开发团队轻易修改。

网络调用还可能需要大量的连接、身份验证和授权配置。
如果这些调用跨多个应用程序(使用多种语言和框架构建)使用，
则必须为每个实例配置这些调用。
此外，网络和安全功能可能需要由组织内的一个中心团队进行管理。
由于代码库很大，对于团队来说，更新他们不熟悉的应用程序代码可能是有风险的。

# 解决方案

将客户机框架和库放入外部进程，该进程充当应用程序和外部服务之间的代理。
在与应用程序相同的主机环境上部署代理，以允许对路由、弹性、安全特性进行控制，
并避免任何与主机相关的访问限制。您还可以使用此模式来标准化和扩展工具。
代理可以监视性能指标，比如延迟或资源使用情况，
这种监视与应用程序发生在同一个主机环境中。

![Ambassador](./ambassador.png)

卸载到 ambassador 的特性可以独立于应用程序进行管理。
您可以在不干扰应用程序遗留功能的情况下更新和修改大使。
它还允许独立的、专门的团队实现和维护安全、网络或身份验证特性，
这些特性已经移交给了大使。

Ambassador 服务可以部署为伴随使用应用程序或服务的生命周期的边车（TODO: 链接到 sidecar 模式）。
如果一个大使由公共主机上的多个独立进程共享，则可以将其部署为守护进程或本机服务。
如果消费服务是容器化的，那么大使应该作为同一主机上的单独容器创建，
并配置适当的链接以进行通信。

# 问题与注意事项

* 代理增加了一些延迟开销。考虑一下应用程序直接调用的客户端库是否是更好的方法
* 考虑在代理中包含广义特性的可能影响。例如，大使可以处理重试，
  但是除非所有操作都是幂等的，否则可能不安全。
* 考虑一种机制，允许客户机将一些上下文传递给代理，同时也传递回客户机。
  例如，包含 HTTP 请求头以选择不重试或指定重试的最大次数。
* 考虑如何打包和部署代理。
* 考虑对所有客户端使用单个共享实例还是对每个客户端使用单个实例。

# 何时使用

遇到以下情况时可以使用此模式：

* 需要为多种语言或框架构建一组通用的客户端连接特性。
* 需要向基础设施开发人员或其他更专业的团队转移跨部门客户机连通性问题。
* 需要在遗留应用程序或难以修改的应用程序中支持云或集群连接需求。

此模式可能不适用于以下情况：

* 当网络请求延迟至关重要时。代理将引入一些开销，尽管开销很小，但在某些情况下可能会影响应用程序。
* 当客户端连接特性被单一语言使用时。在这种情况下，一个更好的选择可能是作为一个包分发给开发团队的客户端库。
* 当连接特性不能一般化并且需要与客户机应用程序进行更深入的集成时。

# 示例

下图显示应用程序通过 ambassador 代理向远程服务发出请求。Ambassador 提供路由、断路和日志记录。
它调用远程服务，然后将响应返回给客户端应用程序:
