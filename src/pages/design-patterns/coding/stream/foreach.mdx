# æ€è·¯äºŒï¼šåŸºäº `forEach`

åŸæ–‡è§ï¼š[ä¸€ç§æ–°çš„æµï¼šä¸ºJavaåŠ å…¥ç”Ÿæˆå™¨(Generator)ç‰¹æ€§](https://mp.weixin.qq.com/s/v-HMKBWxtz1iakxFL09PDw)

ä¸‹é¢ä»¥æˆ‘çš„æ–¹å¼æ¥ç®€å•å™è¿°ä¸€éã€‚

## æ ¸å¿ƒæ¥å£

æ•´ä¸ªæ•…äº‹å¼€å§‹äºè¿™æ ·ä¸€ä¸ªæ¥å£ï¼š

```java
// ä¸ºäº†å’Œæ€è·¯ä¸€ç§çš„ `Sequence` åšåŒºåˆ†ï¼Œè¿™é‡Œå–åå« `Traversable`
public interface Traversable<T> {
    void forEach(Consumer<? super T> consumer);
}
```

## åˆ›å»º `Traversable`

ä¸ºäº†èƒ½å¤Ÿå¼€å§‹ï¼Œæˆ‘ä»¬éœ€è¦å‡ ä¸ªå·¥å‚æ–¹æ³•ï¼š

```java
public interface Traversable<T> {

    static <T> Traversable<T> empty() {
        return Functions::consumeNothing;
    }

    static <T> Traversable<T> from(Iterable<T> list) {
        return list == null ? Traversable.empty() : list::forEach;
    }

    @SafeVarargs
    static <T> Traversable<T> just(T... args) {
        return tConsumer -> {
            for (T t : args) {
                tConsumer.accept(t);
            }
        };
    }
}
```

æ— é™åºåˆ—ä¹Ÿå¾ˆç®€å•ï¼š

```java
@SuppressWarnings("InfiniteLoopStatement")
static Traversable<Long> infinite(long start) {
    var counter = new LongCounter(start);
    return consumer -> {
        while (true) {
            consumer.accept(counter.getAndIncr());
        }
    };
}
```

## æ“ä½œ `Traversable`

`map` å’Œ `filter` éå¸¸ç®€å•ï¼š

```java
default <R> Traversable<R> map(Function<T, R> mapFn) {
    Objects.requireNonNull(mapFn);
    return rConsumer -> this.forEach(t -> rConsumer.accept(mapFn.apply(t)));
}

default Traversable<T> filter(Predicate<T> predicate) {
    Objects.requireNonNull(predicate);
    return tConsumer -> this.forEach(t -> {
        if (predicate.test(t)) {
            tConsumer.accept(t);
        }
    });
}
```

`take` è¾ƒä¸ºéº»çƒ¦ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›åœ¨ take åˆ°è¶³å¤Ÿçš„å…ƒç´ åï¼Œå°±ç»ˆæ­¢ç»§ç»­ takeã€‚
è¿™é‡Œè¦ä¸­æ–­ï¼Œæˆ‘ä»¬å°±åªèƒ½æŠ›ä¸ªå¼‚å¸¸äº†ï¼Œå³ï¼šæŠ›å®Œå¼‚å¸¸å°±æ­£å¸¸ç»ˆæ­¢ã€‚

```java
default Traversable<T> take(final int n) {
    if (n < 1) throw new IllegalArgumentException();


    return StopException.stop(tConsumer -> {
        Counter counter = new Counter(0);
        this.forEach(t -> {
            if (counter.getAndIncr() < n) {
                tConsumer.accept(t);
            }

            if (counter.get() >= n) {
                throw StopException.INSTANCE;
            }
        });
    });
}
```

æ³¨æ„ï¼Œæˆ‘ä»¬åªæ˜¯å€Ÿç”¨ Java çš„å¼‚å¸¸æœºåˆ¶æ¥ä¸­æ–­åç»­æ“ä½œï¼Œè€Œä¸æ˜¯çœŸçš„åœ¨ä¹è¿™ä¸ªå¼‚å¸¸ï¼Œéœ€è¦åœ¨å¤–é¢æ•è·ã€‚
æˆ‘ä»¬ç”šè‡³ä¸å…³å¿ƒè¿™ä¸ªå¼‚å¸¸çš„ stackTraceã€‚æ‰€ä»¥ `StopException` å¼ è¿™ä¸ªæ ·å­ï¼š

```java
class StopException extends RuntimeException {

    private StopException() { super("", null, false, false); }

    static final StopException INSTANCE = new StopException();

    static <T> Traversable<T> stop(Traversable<T> traversable) {
        return tConsumer -> {
            try {
                traversable.forEach(tConsumer);
            } catch (StopException ignored) { }
        };
    }

    static void stop(Runnable runnable) {
        try {
            runnable.run();
        } catch (StopException ignored) { }
    }
}
```

ä¸‹é¢æˆ‘ä»¬å†™ä¸€æ®µä»£ç æµ‹è¯•ä¸€ä¸‹ï¼š

```java
static void main(String[] args) {
    var t = infinite(0)
            .filter(i -> {
                System.out.printf("=> filter: %d > 1\n", i);
                return i > 1;
            })
            .map(i -> {
                System.out.printf("=> map: %d + 4 = %d\n", i, i + 4);
                return i + 4;
            })
            .take(2);
    System.out.println("============");
    t.forEach(it -> System.out.printf("=> forEach %d \n", it));
    System.out.println("============");
}
```

è¾“å‡ºï¼š

```
============
=> filter: 0 > 1
=> filter: 1 > 1
=> filter: 2 > 1
=> map: 2 + 4 = 6
=> forEach 6
=> filter: 3 > 1
=> map: 3 + 4 = 7
=> forEach 7
============
```

å®Œç¾ï¼

## å…¶ä»–æ“ä½œ

### `flatMap`

```java
default <R> Traversable<R> flatMap(Function<T, Traversable<R>> flatMapFn) {
    return consumer -> this.forEach(t -> {
        Traversable<R> rt = flatMapFn.apply(t);
        if (rt != null) {
            rt.forEach(consumer);
        }
    });
}
```

### `reduce`

```java
default <R> R reduce(R initValue, BiFunction<R, T, R> reducer) {
    var rHolder = new ObjectHolder<>(initValue);
    this.forEach(t -> rHolder.set(reducer.apply(rHolder.value(), t)));
    return rHolder.value();
}
```

### `iterator`

ç”¨è¿™ä¸ªæ¥å£å®ç° `iterator()` ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯è¿”å›çš„ `Iterator` å®ƒä¸ lazy ğŸ˜‚ã€‚
ä¸»è¦åŸå› åœ¨äºï¼Œè¿™ä¸ªæ¥å£æ²¡åŠæ³•æŒ‰é¡ºåºä¸€æ¬¡åªå–ä¸€ä¸ªå…ƒç´ ã€‚å› ä¸ºä»£ç ä¹Ÿå¾ˆç®€å•ï¼Œæ‰€ä»¥å°±ä¸åˆ—å‡ºæ¥äº†ã€‚

å…¶ä»–æ“ä½œä¹Ÿä¸åˆ—å‡ºæ¥äº†ã€‚
