# æ€è·¯ä¸€ï¼šåŸºäºé“¾è¡¨

åœ¨å¾ˆå¤šå‡½æ•°å¼è¯­è¨€ä¸­ï¼Œåˆ—è¡¨æ˜¯é€šè¿‡é“¾è¡¨æ¥å®ç°çš„ã€‚åœ¨ scheme ä¸­ï¼Œé€šè¿‡ `cons` æ¥æ„é€ åˆ—è¡¨ã€‚
æ¯”è¾ƒæ–°çš„è¯­è¨€ moonbit ä¹Ÿæ˜¯è¿™ä¹ˆå¤„ç†çš„ã€‚

## ç¬¬ä¸€ç‰ˆ

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª `Sequence` æ¥å£æ¥æè¿°è¿™ä¸ªä¸œè¥¿ï¼š

```java
public sealed interface Sequence<T> {
    record Cons<T>(T value, Sequence<T> rest) implements Sequence<T> {
    }

    @SuppressWarnings("rawtypes")
    enum Nil implements Sequence {
        INSTANCE
    }

    @SuppressWarnings("unchecked")
    static <T> Sequence<T> nil() {
        return Nil.INSTANCE;
    }
}
```

æœ‰äº†è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„é€ åˆ—è¡¨äº†ï¼š

```java
var seq = new Cons<>(1, new Cons<>(2, new Cons<>(3, new Cons<>(4, nil()))));
```


æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€äº›æ“ä½œï¼š

```java
seal interface Sequence<T> {
    // ...

    default Optional<T> first() {
        return switch (this) {
            case Sequence.Nil ignored -> Optional.empty();
            case Sequence.Cons<T> cons -> Optional.ofNullable(cons.value);
        };
    }

    default <R> Sequence<R> map(Function<T, R> mapper) {~
        Objects.requireNonNull(mapper);
        return switch (this) {
            case Nil nil -> nil;
            case Cons<T> cons -> new Cons<>(mapper.apply(cons.value), cons.rest().map(mapper));
        };
    }

    default Sequence<T> filter(Predicate<T> predicate) {
        Objects.requireNonNull(predicate);
        return switch (this) {
            case Nil nil -> nil;
            case Cons<T> cons -> predicate.test(cons.value)
                    ? new Cons<>(cons.value, cons.rest().filter(predicate))
                    : cons.rest().filter(predicate);
        };
    }

    default Sequence<T> take(int n) {
        if (n < 1) return nil();
        return switch (this) {
            case Nil nil -> nil;
            case Cons<T> cons -> new Cons<>(cons.value, cons.rest().take(n - 1));
        };
    }


    default void forEach(Consumer<T> consumer) {
        Objects.requireNonNull(consumer);
        for (var curr = this; curr instanceof Sequence.Cons<T> cons; curr = cons.rest()) {
            consumer.accept(cons.value);
        }
    }
}
```

ä¸‹é¢æˆ‘ä»¬å†™ä¸€æ®µä»£ç æµ‹è¯•ä¸€ä¸‹ï¼š

```java
static void main(String[] args) {
    var seq = new Cons<>(1, new Cons<>(2, new Cons<>(3, new Cons<>(4, nil()))));
    var handledSeq = seq
            .map(i -> {
                System.out.printf("=> map: %d + 4 = %d\n", i, i + 4);
                return i + 4;
            })
            .take(3);
    System.out.println("============");
    handledSeq.forEach(it -> System.out.printf("=> forEach %d\n", it));
}
```

è¿™æ®µä»£ç è¾“å‡ºå¦‚ä¸‹ï¼š

```
=> map: 1 + 4 = 5
=> map: 2 + 4 = 6
=> map: 3 + 4 = 7
=> map: 4 + 4 = 8
============
=> forEach 5
=> forEach 6
=> forEach 7
```

å¯ä»¥çœ‹åˆ° `handledSeq` åœ¨è¢«åˆå§‹åŒ–åå°±å·²ç»è¢«è®¡ç®—å‡ºæ¥äº†ï¼Œè¿™è¯´æ˜å®ƒä¸æ˜¯ lazy çš„ã€‚
å¦å¤–ï¼Œæˆ‘ä»¬æ³¨æ„åˆ° `Cons` ç±»çš„ç»“æ„æ— æ³•å®ç°æ— é™åˆ—è¡¨ã€‚

## ç¬¬äºŒç‰ˆï¼šä¿®æ”¹ `Cons`

å› ä¸º `Cons` ç±»çš„ç»“æ„æ— æ³•å®ç°æ— é™åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸€ä¸‹å®ƒçš„ç»“æ„ï¼š

```java
final class Cons<T> implements Sequence<T> {
    private final T value;
    private final Supplier<Sequence<T>> getRest;

    Cons(T value, Sequence<T> rest) {
        Objects.requireNonNull(rest);
        this.value = value;
        this.getRest = () -> rest;
    }

    Cons(T value, Supplier<Sequence<T>> restSupplier) {
        this.value = value;
        this.getRest = Objects.requireNonNull(restSupplier);
    }

    public T value() {
        return value;
    }

    public Sequence<T> rest() {
        return getRest.get();
    }
}
```

ä¿®æ”¹åçš„ç‰ˆæœ¬ä¸­ï¼Œ`rest()` è¿”å›å€¼æ˜¯ç”±ä¸€ä¸ªå‡½æ•°ç”Ÿæˆçš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¯¹å…¶åŠ¨æ‰‹è„šäº†ã€‚
æ— é™åˆ—è¡¨å¯ä»¥è¿™æ ·å®ç°ï¼š

```java
static <T> Sequence<Long> infinite(long start) {
    return new Cons<>(start, () -> infinite(start + 1));
}
```

æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š

```java
static void main(String[] args) {
    var seq = infinite(0L);
    var handledSeq = seq
            .map(i -> {
                System.out.printf("=> map: %d + 4 = %d\n", i, i + 4);
                return i + 4;
            })
            .take(3);
    System.out.println("============");
    handledSeq.forEach(it -> System.out.printf("=> forEach %d\n", it));
}
```

å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ¬¡ç¨‹åº `StackOverflowError` äº†ï¼ŒåŸå› æ˜¯ `map` ä¸æ˜¯ lazy çš„ï¼Œ`take(3)` ä¹‹å‰è¦æŠŠ `map` ç»“æœå…¨éƒ¨è®¡ç®—å‡ºæ¥ï¼Œè€Œè¿™æ˜¯ä¸å¯èƒ½çš„ã€‚

æˆ‘ä»¬ç¢°å·§å†™äº†ä¸€ä¸ªæµ‹è¯•çº¿ç¨‹æ ˆæ·±åº¦çš„ç¨‹åº ğŸ˜‚ã€‚

ä¸‹é¢æˆ‘ä»¬æƒ³åŠæ³•æŠŠå®ƒå˜æˆ lazy çš„ã€‚

## ç¬¬ä¸‰ç‰ˆï¼š`LazySequence`

lazy çš„è¦ç‚¹åœ¨äºï¼Œåœ¨éœ€è¦æ—¶æ‰ä» `Sequence` ä¸­è¦ä¸€ä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šé¢çš„ä»£ç ä¸­ï¼Œå˜é‡ `handledSeq`
åœ¨è¢«åˆå§‹åŒ–åï¼Œ`map` å’Œ `take` ä¸åº”å‘ç”Ÿä»»ä½•è®¡ç®—ï¼Œåªæœ‰åœ¨ `forEach` éå†æ—¶æ‰åº”è¯¥è®¡ç®—ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¢åŠ ä¸€ä¸ªç±» `LazySequence`:

```java
public interface LazySequence<T> {
    Sequence<T> get();

    static <T> LazySequence<T> create(Sequence<T> sequence) {
        Objects.requireNonNull(sequence);
        return () -> sequence;
    }
}
```

æˆ‘ä»¬æŠŠåˆšæ‰çš„å‡ ä¸ªå‡½æ•°ä¹Ÿå®ç°ä¸€éï¼š

```java
public interface LazySequence<T> {
    // ...

    default LazySequence<T> filter(Predicate<T> predicate) {
        Objects.requireNonNull(predicate);
        return () -> this.get().filter(predicate);
    }

    default <R> LazySequence<R> map(Function<T, R> mapper) {
        Objects.requireNonNull(mapper);
        return () -> this.get().map(mapper);
    }

    default LazySequence<T> take(int n) {
        return () -> this.get().take(n);
    }

    default void forEach(Consumer<T> consumer) {
        this.get().forEach(Objects.requireNonNull(consumer));
    }
}
```

ç°åœ¨æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ä»£ç ï¼š

```java
static void main(String[] args) {
    var seq = new Sequence.Cons<>(1, new Sequence.Cons<>(2, new Sequence.Cons<>(3, new Sequence.Cons<>(4, Sequence.nil()))));
    var lazy = create(seq);
    var handled = lazy
            .map(i -> {
                System.out.printf("=> map: %d + 4 = %d\n", i, i + 4);
                return i + 4;
            })
            .take(2);
    System.out.println("============");
    handled.forEach(it -> System.out.printf("=> forEach %d\n", it));
    System.out.println("============");
    create(Sequence.infinite(0)).take(4).forEach(System.out::println);
}
```

è¾“å‡ºå¦‚ä¸‹ï¼š

```
============
=> map: 1 + 4 = 5
=> map: 2 + 4 = 6
=> map: 3 + 4 = 7
=> map: 4 + 4 = 8
=> forEach 5
=> forEach 6
============
0
1
2
3
```

å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè®¡ç®—çœŸçš„ â€œlazyâ€ äº†ï¼Œâ€œå¥½åƒâ€ä¹Ÿèƒ½å¤„ç†æ— é™åˆ—è¡¨äº†ã€‚ä½†æ˜¯æœ‰ä¸€äº›é—®é¢˜ï¼šåœ¨ `take(2)` ä¹‹å‰çš„ `map` æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒåªæ‰§è¡Œä¸¤æ¬¡ï¼Œä½†æ˜¯å®ƒæ‰§è¡Œäº†å››æ¬¡ã€‚
è¿™æ„å‘³ç€ï¼Œä¸‹é¢çš„ä»£ç è¿˜æ˜¯ä¼š `StackOverflowError`:

```java
create(Sequence.infinite(0)).map(it -> it * 2).take(4).forEach(System.out::println);
```

è¿™ã€‚ã€‚ã€‚

çœ‹æ¥ `LazySequence` ä¸å¤§è¡Œå‘€ã€‚æˆ‘ä»¬å†æ”¹ä¸€æ”¹ï¼š

## ç¬¬å››ç‰ˆï¼šå‡çº§ `LazySequence`

æˆ‘ä»¬å¸Œæœ›åœ¨æœ€å `forEach` æ—¶ï¼Œéœ€è¦ä¸€ä¸ªå…ƒç´ ï¼Œå°±ä»ä¸Šé¢è¦ä¸€ä¸ªï¼Œè¿™ä¸ªå…ƒç´ æŠŠä¸Šé¢çš„æ­¥éª¤éƒ½æ‰§è¡Œå®Œä¹‹åï¼Œå†è¦ä¸€ä¸ªï¼Œç›´åˆ°ç»“æŸã€‚æˆ‘ä»¬æŠŠ `LazySequence` æ”¹æˆè¿™æ ·ï¼š

```java
public interface LazySequence<T> {
    Current<T> popCurrent();

    static <T> LazySequence<T> create(Sequence<T> sequence) {
        Objects.requireNonNull(sequence);
        return new LazySequence<>() {
            private Sequence<T> current = sequence;

            @Override
            public Current<T> popCurrent() {
                return switch (current) {
                    case Sequence.Nil ignored -> Current.end();
                    case Sequence.Cons<T> cons -> {
                        var value = new Current.Value<>(cons.value());
                        current = cons.rest();
                        yield value;
                    }
                };
            }
        };
    }

    static <T> LazySequence<T> empty() { return Current::end; }
}

sealed interface Current<T> {
    record Value<T>(T value) implements Current<T> { }

    @SuppressWarnings("rawtypes")
    enum End implements Current { INSTANCE }

    @SuppressWarnings("unchecked")
    static <T> Current<T> end() { return End.INSTANCE; }
}
```

æˆ‘ä»¬æŠŠåˆšæ‰çš„å‡ ä¸ªå‡½æ•°ä¹Ÿå®ç°ä¸€éï¼š

```java
public interface LazySequence<T> {
    default LazySequence<T> filter(Predicate<T> predicate) {
        Objects.requireNonNull(predicate);
        return () -> {
            while (true) {
                switch (this.popCurrent()) {
                    case Current.End ignored -> {
                        return Current.end();
                    }
                    case Current.Value<T> value -> {
                        if (predicate.test(value.value())) {
                            return value;
                        }
                    }
                }
            }
        };
    }

    default <R> LazySequence<R> map(Function<T, R> mapper) {
        Objects.requireNonNull(mapper);
        return () -> switch (this.popCurrent()) {
            case Current.End end -> end;
            case Current.Value<T> value -> new Current.Value<>(mapper.apply(value.value()));
        };
    }

    default LazySequence<T> take(int n) {
        var counter = new Counter(0);
        return () -> counter.getAndIncr() < n ? this.popCurrent() : Current.end();
    }

    default void forEach(Consumer<T> consumer) {
        Objects.requireNonNull(consumer);
        for (var current = this.popCurrent(); current instanceof Current.Value<T> value; current = this.popCurrent()) {
            consumer.accept(value.value());
        }
    }
}
```

ä¸‹é¢æˆ‘ä»¬å†™ä¸€æ®µä»£ç æµ‹è¯•ä¸€ä¸‹ï¼š

```java
static void main(String[] args) {
    var seq = new Sequence.Cons<>(1, new Sequence.Cons<>(2, new Sequence.Cons<>(3, new Sequence.Cons<>(4, Sequence.nil()))));
    var lazy = create(seq);
    var handled = lazy
            .filter(i -> {
                System.out.printf("=> filter: %d > 1\n", i);
                return i > 1;
            })
            .map(i -> {
                System.out.printf("=> map: %d + 4 = %d\n", i, i + 4);
                return i + 4;
            })
            .take(2);
    System.out.println("============");
    handled.forEach(it -> System.out.printf("=> forEach %d \n", it));
    System.out.println("============");
    create(Sequence.infinite(0)).map(it -> it * 2).take(3).forEach(System.out::println);
}
```

è¾“å‡ºå¦‚ä¸‹ï¼š

```
============
=> filter: 1 > 1
=> filter: 2 > 1
=> map: 2 + 4 = 6
=> forEach 6
=> filter: 3 > 1
=> map: 3 + 4 = 7
=> forEach 7
============
0
2
4
```

å®Œç¾ï¼

æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬çš„ `LazySequence` å¹¶æ²¡æœ‰ä½¿ç”¨ `Sequence` ä¸­çš„ `map`ã€`filter`ã€`take`ã€`forEach`
ç­‰æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ `Sequence` ä¸­å¯ä»¥æŠŠå®ƒä»¬åˆ é™¤äº†ã€‚

## æ‹“å±• `LazySequence`

ç°åœ¨æˆ‘ä»¬å¯ä»¥åŸºäº `LazySequence` å®ç°ä¸€äº›æ–¹æ³•äº†ï¼Œæ¯”å¦‚ï¼š

### `iteratoer`

```java
default Iterator<T> iterator() {
    var self = this;
    return new Iterator<T>() {
        private Current<T> current = self.popCurrent();

        @Override
        public boolean hasNext() {
            return current instanceof Current.Value<T>;
        }

        @Override
        public T next() {
            return switch (current) {
                case Current.End ignored -> throw new NoSuchElementException();
                case Current.Value<T> value -> {
                    current = self.popCurrent();
                    yield value.value();
                }
            };
        }
    };
}
```

### `flatMap`

```java
default <R> LazySequence<R> flatMap(Function<T, Sequence<R>> fn) {
    Objects.requireNonNull(fn);
    var holder = new ObjectHolder<LazySequence<R>>(null);
    return () -> {
        while (true) {
            if (holder.value() == null) {
                switch (this.popCurrent()) {
                    case Current.End ignore -> {
                        return Current.end();
                    }
                    case Current.Value<T> value -> holder.set(create(fn.apply(value.value())));
                }
            }

            var holdLazySeq = holder.value();
            switch (holdLazySeq.popCurrent()) {
                case Current.Value<R> value -> {
                    return value;
                }
                case Current.End ignored -> holder.set(null);
            }
        }
    };
}
```

### `concat`

```java
default LazySequence<T> concat(Sequence<T> sequence) {
    var second = create(sequence);
    return () -> switch (this.popCurrent()) {
        case Current.End ignored -> second.popCurrent();
        case Current.Value<T> value -> value;
    };
}

default LazySequence<T> concat(Iterable<T> iterable) {
    return concat(Sequence.from(iterable));
}
```

### `reduce`

```java
default <R> R reduce(R init, BiFunction<T, R, R> reducer) {
    Objects.requireNonNull(reducer);
    R result = init;
    for (var current = this.popCurrent(); current instanceof Current.Value<T> value; current = this.popCurrent()) {
        result = reducer.apply(value.value(), result);
    }
    return result;
}

default List<T> toList() {
    return this.reduce(new ArrayList<>(), (it, li) -> {
        li.add(it);
        return li;
    });
}

default Set<T> toSet() {
    return this.reduce(new HashSet<>(), (it, li) -> {
        li.add(it);
        return li;
    });
}
```

è¿›ä¸€æ­¥åœ°

### `reverse`

```java
default LazySequence<T> reverse() {
    var list = this.toList();
    return create(Sequence.from(list.reversed()));
}
```

æ³¨æ„ï¼Œ`reverse` å’Œä¸Šé¢çš„ `filter`ã€`map`ã€`flatMap` ä¹‹ç±»çš„éƒ½éå¸¸ä¸åŒã€‚
åŸå› åœ¨äºï¼Œåœ¨ä¸€è¿ä¸²çš„æ­¥éª¤ä¸­ï¼Œå¦‚æœè¿›è¡Œåˆ°äº† `reverse` è¿™ä¸€æ­¥æ—¶ï¼Œå®ƒè¦æŠŠä¸Šä¸€æ­¥éª¤å¯ä»¥è·å¾—çš„å…ƒç´ éƒ½ç»™å¤„ç†å®Œæ‰è¡Œã€‚

å…¶ä»–çš„è¯¸å¦‚ `unique`ã€`skip`ã€`orderBy` ä¹‹ç±»çš„å°±ä¸åœ¨è¿™é‡Œå®ç°äº†ã€‚æ€»ä¹‹éå¸¸ç®€å•ã€‚