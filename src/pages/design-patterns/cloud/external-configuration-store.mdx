---
title: External Configuration Store Pattern
translateFrom: https://docs.microsoft.com/en-us/azure/architecture/patterns/external-configuration-store
---

将配置信息从应用程序部署包移到集中的位置。
这可以为更容易地管理和控制配置数据以及跨应用程序和应用程序实例共享配置数据提供机会。

# 问题背景

大多数应用程序运行时环境包括与应用程序一起部署的文件中保存的配置信息。
在某些情况下，可以编辑这些文件，以便在部署后更改应用程序行为。
但是，对配置的更改需要重新部署应用程序，这通常会导致不可接受的停机时间和其他管理开销。

本地配置文件还将配置限制为单个应用程序，但有时在多个应用程序之间共享配置设置会很有用。
示例包括数据库连接字符串、 UI 主题信息或相关应用程序集使用的队列和存储的 URL。

跨应用程序的多个运行实例管理对本地配置的更改是一个挑战，特别是在云托管场景中。
在部署更新时，它可能导致实例使用不同的配置设置。

此外，对应用程序和组件的更新可能需要更改配置模式。
许多配置系统不支持不同版本的配置信息。

# 解决方案

将配置信息存储在外部存储器中，并提供一个可用于快速有效地读取和更新配置设置的接口。
外部存储的类型取决于应用程序的托管和执行期函式库。
在云托管场景中，它通常是基于云的存储服务或专用配置服务，但也可以是托管数据库或其他定制系统。

您为配置信息选择的后备存储应该具有一个提供一致和易于使用的访问的接口。
它应该以正确类型和结构化的格式公开信息。
实现可能还需要授权用户的访问，以保护配置数据，并且要足够灵活，
允许存储配置的多个版本(例如开发、登台或生产，包括每个版本的多个发布版本)。

> 许多内置的配置系统在应用程序启动时读取数据，并在内存中缓存数据，
> 以提供快速访问并尽量减少对应用程序性能的影响。根据所使用的后台存储的类型以及此存储的延迟，
> 在外部配置存储中实现缓存机制可能会有所帮助。有关更多信息，请参见
> [缓存指南](https://docs.microsoft.com/en-us/previous-versions/msp-n-p/dn589802(v=pandp.10))。
> 该图说明了使用可选的本地缓存的外部配置存储模式的概述。

![external-configuration-store-overview](/asset/img/external-configuration-store-overview.png)

# 问题与注意事项

在决定如何实现此模式时，请考虑以下几点:

选择一个能够提供可接受的性能、高可用性、健壮性，
并且可以作为应用程序维护和管理过程的一部分进行备份的后备存储。
在云托管应用程序中，使用云存储机制或专用配置平台服务通常是满足这些需求的不错选择。

设计后台存储的模式，以允许其可以保存的信息类型具有灵活性。
确保它提供了所有配置要求，例如类型化数据、设置集合、设置的多个版本以及使用它的应用程序所需的任何其他特性。
模式应该易于扩展，以便在需求变化时支持其他设置。

考虑后台存储的物理能力、它与配置信息存储方式的关系以及对性能的影响。
例如，存储包含配置信息的 XML 文档将需要配置接口或应用程序解析文档以读取单个设置。
这会使更新设置变得更加复杂，尽管缓存设置可以帮助抵消较慢的读取性能。

考虑配置接口将如何允许控制配置设置的作用域和继承性。
例如，可能需要在组织、应用程序和计算机级别确定配置设置的范围。
它可能需要支持对访问不同作用域的控制权限的委托，并防止或允许单个应用程序重写设置。

确保配置接口可以以所需的格式公开配置数据，例如类型化值、集合、键/值对或属性袋。

考虑配置存储区接口在设置包含错误或后台存储区中不存在时的行为。
返回默认设置和日志错误可能是合适的。
还要考虑一些方面，比如配置设置键或名称的大小写敏感性、二进制数据的存储和处理，
以及处理 null 或空值的方式。

考虑如何保护配置数据，以便只允许访问适当的用户和应用程序。
这可能是配置存储接口的一个特性，但是也有必要确保在没有适当权限的情况下不能直接访问后台存储中的数据。
确保读写配置数据所需权限之间的严格分离。
还要考虑是否需要对部分或全部配置设置进行加密，以及如何在配置存储接口中实现这些设置。

中央存储配置在运行时期间更改应用程序行为，这一点至关重要，
应使用与部署应用程序代码相同的机制部署、更新和管理中央存储配置。
例如，可能影响多个应用程序的更改必须使用完全测试和分阶段部署方法来执行，
以确保更改适合所有使用此配置的应用程序。如果管理员编辑设置以更新一个应用程序，
则可能对使用相同设置的其他应用程序产生不利影响。

如果应用程序缓存配置信息，则在配置更改时需要通知应用程序。
可以对缓存的配置数据实现过期策略，以便定期自动刷新此信息，并接收(并处理)任何更改。

虽然缓存配置数据可以帮助解决应用程序运行时外部配置存储的瞬态连接问题，
但是如果在应用程序首次启动时外部存储关闭，这通常不能解决问题。
如果应用程序在启动时无法检索实时值，请确保应用程序部署管道可以提供配置文件中已知的最后一组配置值作为后备。

# 何时使用此模式

以下场景适用此模式：

* 在多个应用程序和应用程序实例之间共享的配置设置，
  或者必须跨多个应用程序和应用程序实例执行标准配置的配置设置。
* 不支持所有必需配置设置(如存储映像或复杂数据类型)的标准配置系统。
* 作为应用程序某些设置的补充存储，可能允许应用程序覆盖部分或全部中央存储设置。
* 作为简化多个应用程序管理的一种方法，还可以通过记录对配置存储区的部分或全部访问类型来监视配置设置的使用。