---
title: Federated Identity pattern
translateFrom: https://docs.microsoft.com/en-us/azure/architecture/patterns/federated-identity
---

import { Alert } from "../../components/Alert";

将身份验证委托给外部标识提供程序。这可以简化开发，减少对用户管理的需求，并改善应用程序的用户体验。

# 问题背景

用户通常需要使用与他们有业务关系的不同组织提供和托管的多个应用程序。
这些用户可能需要为每个用户使用特定的(和不同的)凭据。这个可以:

* **导致用户体验脱节**。当用户有许多不同的登录凭证时，他们常常会忘记登录凭证。
* **暴露安全漏洞**。当用户离开公司时，帐户必须立即被删除。在大型组织中很容易忽视这一点。
* **复杂的用户管理**。管理员必须管理所有用户的凭据，并执行其他任务，如提供密码提醒。

用户通常喜欢对所有这些应用程序使用相同的凭据。

# 解决方案

实现可以使用联邦标识的身份验证机制。
将用户身份验证与应用程序代码分开，并将身份验证委托给受信任的标识提供程序。
这可以简化开发，并允许用户使用更广泛的标识提供程序(IdP)进行身份验证，同时最大限度地减少管理开销。
它还允许您清楚地将身份验证与授权解耦。

受信任的身份认证提供商包括企业目录、内部联合服务、其他由业务伙伴提供的安全令牌服务(STS)，
或者可以认证拥有微软、谷歌、雅虎或 Facebook 账户的用户的社交身份认证提供商。

图1说明了当客户端应用程序需要访问需要身份验证的服务时，联邦标识模式的原则。
身份验证由身份提供者(IDP)执行，它与安全令牌服务(STS)协同工作。IdP 发出安全令牌，
断言有关经过身份验证的用户的信息。这些信息称为声明，包括用户的标识，
还可能包括其他信息，如角色成员资格和更细粒度的访问权限。

![federated-identity](/asset/img/federated-identity-1.png)

图1-联邦身份验证的概述

这种模型通常称为基于索赔的访问控制（*claims-based access control*）。
应用程序和服务授权基于令牌中包含的声明访问特性和功能。需要身份验证的服务必须信任 IdP。
客户端应用程序联系执行身份验证的 IdP。如果身份验证成功，IdP 将返回一个令牌，
其中包含向 STS 标识用户的声明(请注意，IdP 和 STS 可能是相同的服务)。
STS 可以根据预定义的规则转换和增加令牌中的索赔，然后再将其返回给客户机。
然后，客户端应用程序可以将此令牌作为其标识的证明传递给服务。

<Alert title="Note" size="small">
在某些情况下，信任链中可能存在额外的 STS。例如，在后面描述的 Microsoft Azure 场景中，
内部 STS 信任另一个 STS，该 STS 负责访问身份提供者以验证用户。
这种方法在企业场景中很常见，在这些场景中有一个内部 STS 和目录。
</Alert>

联合身份验证提供了一种基于标准的解决方案，用于解决跨不同域的信任身份问题，并支持单点登录。
它在所有类型的应用程序中变得越来越普遍，特别是云托管应用程序，因为它支持单点登录，
而不需要直接与身份提供商建立网络连接。用户不必为每个应用程序输入凭据。
这增强了安全性，因为它可以防止访问许多不同应用程序所需的凭据的扩散，
而且它还向除原始标识提供程序之外的所有用户隐藏了用户的凭据。
应用程序只看到令牌中包含的经过身份验证的身份信息。

联邦身份还有一个主要优势，即身份和凭据的管理是身份提供者的责任。
应用程序或服务不需要提供身份管理特性。此外，在公司场景中，
公司目录不需要了解用户(前提是它信任身份提供者) ，这样可以消除管理目录中的用户身份的所有管理开销。

# 问题与注意事项

在设计实现联邦身份验证的应用程序时，请考虑以下事项:

* 身份验证可以是单点故障。如果将应用程序部署到多个数据中心，
  请考虑将身份管理机制部署到相同的数据中心，以维护应用程序的可靠性和可用性。
* 身份验证机制可以提供基于身份验证令牌中包含的角色声明配置访问控制的工具。
  这通常被称为以角色为基础的存取控制(RBAC) ，它允许对特性和资源的访问进行更细粒度的控制。
* 与公司目录不同，使用社交身份提供者的基于声明的身份验证通常不提供除电子邮件地址以外的有关经过身份验证的用户的信息，
  也许还包括姓名。一些社交身份认证提供商，比如微软的账户，只提供唯一标识符。
  应用程序通常需要维护关于已注册用户的一些信息，并且能够将这些信息与令牌中声明中包含的标识符匹配。
  通常这是通过注册过程完成的，当用户首次访问应用程序时，然后在每次身份验证之后将信息作为附加声明注入到令牌中。
* 如果为 STS 配置了多个标识提供程序，它必须检测用户应该重定向到哪个标识提供程序以进行身份验证。
  这个过程被称为家园领域发现。STS 可以根据用户提供的电子邮件地址或用户名、用户正在访问的应用程序的子域、
  用户的 IP 地址范围或存储在用户浏览器中的 cookie 内容自动执行此操作。
  例如，如果用户在 Microsoft 域中输入了一个电子邮件地址，比如 user@live. com，STS
  将把用户重定向到 Microsoft 帐户登录页面。在随后的访问中，STS 可以使用 cookie
  来表明最后一次登录是使用 Microsoft 帐户。如果自动发现不能确定主域，STS 将显示一个主域发现(HRD)页面
  其中列出了受信任的身份提供程序，用户必须选择他们想要使用的那个。

# 何时使用

这种模式非常适合一系列场景，例如:

* **企业中的单点登录**。在这个场景中，您需要对托管在企业安全边界之外的云中的企业应用程序的员工进行身份验证，
  而不需要他们每次访问应用程序时都进行签名。用户体验与使用内部应用程序时相同，
  这些应用程序在登录到公司网络时进行初始身份验证，然后无需再次登录即可访问所有相关应用程序。
* **具有多个伙伴的联邦身份**。在这个场景中，您需要对公司目录中没有帐户的公司雇员和业务合作伙伴进行身份验证。
  这在 B2B (B2B)应用程序、与第三方服务集成的应用程序以及拥有不同 IT 系统的公司合并或共享资源的情况下很常见。
* **SaaS 应用程序中的联邦标识**。在这个场景中，独立的软件供应商(ISV)为多个客户或租户提供一个现成的服务。
  每个租户都希望使用合适的标识提供程序进行身份验证。例如，业务用户希望我们使用他们的企业凭证，
  而租户的消费者和客户可能希望使用他们的社会身份凭证。

这种模式可能不适用于下列情况:

* 应用程序的所有用户都可以由一个身份提供程序进行身份验证，而且不需要使用任何其他身份提供程序进行身份验证。
  这在只使用企业目录进行身份验证的业务应用程序中很典型，通过使用 VPN
  或(在云托管的场景中)通过内部目录和应用程序之间的虚拟网络连接，可以在应用程序中直接访问这个目录。
* 应用程序最初是使用不同的身份验证机制构建的，可能使用自定义用户存储，
  或者不具备处理基于声明的技术所使用的协商标准的能力。
  将基于声明的身份验证和访问控制改进到现有应用程序中可能很复杂，而且可能不具有成本效益。

# 示例

组织在 Azure 中托管多租户软件即服务(SaaS)应用程序。应用程序包含一个网站，
租户可以使用该网站为自己的用户管理应用程序。该应用程序允许租户使用联邦身份访问租户的网站，
当用户通过该组织自己的 ActiveDirectory 进行身份验证时，
联邦身份由活动目录联合服务(adFS)生成。图2显示了此过程的概述。

![federated-identity](/asset/img/federated-identity-2.png)

图2-大型企业订阅者中的用户如何访问应用程序

在图2所示的场景中，租户使用自己的身份提供者进行身份验证(步骤1) ，
在本例中为 ADFS。在成功地对租户进行身份验证之后，ADFS 发出一个令牌。
客户机浏览器将这个令牌转发给 SaaS 应用程序的联合提供程序(它信任租户的 ADFS 发出的令牌) ，
以便获得对 SaaS 联合提供程序有效的令牌(步骤2)。
如果需要，SaaS 联合提供者在将新令牌返回给客户端浏览器之前，
将令牌中的声明转换为应用程序能够识别的声明(步骤3)。
应用程序信任 SaaS 联合提供程序发出的令牌，并使用令牌中的声明应用授权规则(步骤4)。

租户不需要记住单独的凭据来访问应用程序，租户公司的管理员将能够在自己的 ADFS
中配置可以访问应用程序的用户列表。

# 相关文档

- [What is Federated Identity? How it Works and Benefits](https://www.onelogin.com/learn/federated-identity)
- [federated identity management (FIM) ](https://www.techtarget.com/searchsecurity/definition/federated-identity-management)