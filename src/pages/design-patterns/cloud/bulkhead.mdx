---
title: Bulkhead Pattern
translateFrom: https://docs.microsoft.com/en-us/azure/architecture/patterns/bulkhead
---

隔板模式是一种能够容忍失败的应用程序设计类型。
在隔板架构中，应用程序的元素被隔离到池中，以便在一个池失败时，其他元素继续运行。
它以船体的隔板(舱壁)命名。
如果船体受损，只有受损的部分会充满水，从而防止船只沉没。

# 问题背景

一个基于云的应用程序可能包含多个服务，每个服务都有一个或多个使用者。
服务中的过度负载或故障将影响服务的所有使用者。

此外，使用者可以同时向多个服务发送请求，使用每个请求的资源。
当使用者向配置错误或没有响应的服务发送请求时，客户端请求所使用的资源可能无法及时释放。
随着对服务的请求继续，这些资源可能会耗尽。
例如，客户端的连接池可能已经耗尽。此时，消费者对其他服务的请求将受到影响。
最终，消费者不再能够向其他服务发送请求，而不仅仅是原始的无响应服务。

同样的资源耗尽问题也会影响具有多个使用者的服务。
来自一个客户端的大量请求可能会耗尽服务中的可用资源。
其他消费者不再能够使用该服务，从而导致级联故障效应。

# 解决方案

根据使用者负载和可用性需求，将服务实例分成不同的组。
这种设计有助于隔离故障，并允许您为某些使用者维护服务功能，即使在发生故障时也是如此。

使用者还可以对资源进行分区，以确保用于调用一个服务的资源不会影响用于调用另一个服务的资源。
例如，可以为调用多个服务的使用者为每个服务分配一个连接池。
如果一个服务开始失败，它只会影响为该服务分配的连接池，从而允许使用者继续使用其他服务。

这个模式的好处有：

* 将使用者和服务与级联故障隔离开来。
  影响消费者或服务的问题可以在其自身的隔离壁内隔离，从而防止整个解决方案失败。
* 允许您在服务失败时保留一些功能。应用程序的其他服务和特性将继续工作。
* 允许您部署为使用应用程序提供不同质量服务的服务。可以将高优先级使用者池配置为使用高优先级服务。

下图显示了围绕调用单个服务的连接池构造的舱壁。
如果服务 A 失败或导致其他问题，则连接池是独立的，因此只有使用分配给服务 A 的线程池的工作负载受到影响。
使用服务 B 和 C 的工作负载不受影响，可以继续工作而不中断。

![bulkhead](/asset/img/bulkhead-1.png)

下一个关系图显示了调用单个服务的多个客户端。
每个客户端被分配一个单独的服务实例。客户机1发出了太多的请求，使其实例不堪重负。
因为每个服务实例都与其他服务实例隔离，所以其他客户端可以继续进行调用。

![bulkhead](/asset/img/bulkhead-2.png)

# 问题与注意事项

* 围绕应用程序的业务和技术需求定义分区。
* 在将服务或使用者划分到舱壁时，要考虑技术提供的隔离级别以及成本、性能和可管理性方面的开销。
* 考虑将舱壁与重试、断路器和节流模式相结合，以提供更复杂的故障处理。
* 在将使用者划分到隔离壁时，请考虑使用进程、线程池和信号量。
  [resilience4j](https://github.com/resilience4j/resilience4j)
  和 [Polly](https://github.com/App-vNext/Polly) 等项目为创建消费者舱壁提供了一个框架。
* 当将服务划分到舱壁时，请考虑将它们部署到单独的虚拟机、容器或进程中。
  容器以相当低的开销提供了很好的资源隔离平衡。
* 可以通过不同的队列集隔离使用异步消息进行通信的服务。
  每个队列可以有一组处理队列上消息的专用实例，也可以有一组使用算法进行排队和分派处理的实例。
* 确定舱壁的粒度级别。例如，如果希望跨分区分布租户，
  可以将每个租户放在一个单独的分区中，或者将多个租户放在一个分区中。
* 监视每个分区的性能和 SLA。

# 何时使用

以下场景适用：

* 隔离用于使用一组后端服务的资源，特别是当应用程序可以提供某种级别的功能时，即使其中一个服务没有响应。
* 将关键消费者与标准消费者隔离开来。
* 保护应用程序不受连锁故障的影响。

以下场景可能不适用：

* 在项目中，低效率地使用资源可能是不可接受的。
* 增加的复杂性是没有必要的.

