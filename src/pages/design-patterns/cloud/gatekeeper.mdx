---
title: Gatekeeper Pattern
translateFrom: https://docs.microsoft.com/en-us/azure/architecture/patterns/gatekeeper
---

通过使用专用的主机实例来保护应用程序和服务，该主机实例充当客户机与应用程序或服务之间的代理，
验证和清理请求，并在它们之间传递请求和数据。这可以提供额外的安全层，并限制系统的攻击面。

# 问题背景

应用程序通过接受和处理请求向客户机公开其功能。
在云托管方案中，应用程序公开客户端连接到的端点，通常包括处理来自客户端的请求的代码。
此代码执行身份验证和验证，部分或全部请求处理，并且可能代表客户端访问存储和其他服务。

如果恶意用户能够危害系统并获得对应用程序宿主环境的访问权限，
那么它所使用的安全机制(如凭据和存储密钥)以及它所访问的服务和数据就会公开。
因此，恶意用户可以不受限制地访问敏感信息和其他服务。

# 解决方案

为了尽量减少客户端访问敏感信息和服务的风险，
需要将公开公共端点的主机或任务与处理请求和访问存储的代码分离开来。
您可以通过使用与客户机交互的 facade 或专用任务来实现这一点，
然后将请求(可能通过一个分离的接口)传递给将处理请求的主机或任务。
该图提供了此模式的高级概述。

![gatekeeper](/asset/img/gatekeeper-diagram.png)

网守模式可以简单地用于保护存储，也可以用作更全面的门面来保护应用程序的所有功能。重要因素包括:

* **受控验证**。网守验证所有请求，并拒绝那些不符合验证要求的请求。
* **风险和风险有限**。网守不能访问受信任的主机用来访问存储和服务的凭据或密钥。
  如果网守被攻击，攻击者就无法访问这些凭证或密钥。
* **适当的安全**。网守以有限特权模式运行，
  而应用程序的其余部分则以访问存储和服务所需的完全信任模式运行。
  如果网守被破坏，它就不能直接访问应用程序服务或数据。

这种模式在典型的网络地形中起到防火墙的作用。
它允许网守检查请求，并决定是否将请求传递给执行所需任务的受信任主机。
这种决策通常要求网守在将请求内容传递给受信任的主机之前对其进行验证和过滤。

# 问题与注意事项

在决定如何实现此模式时，请考虑以下几点:

* 确保受信任的主机的网守只传递公开内部或受保护的端点的请求，并且只连接到网守。
  受信任的主机不应该公开任何外部端点或接口。
* 网关守卫必须在有限的权限模式下运行。通常这意味着在单独的托管服务或虚拟机中运行网守和受信任的主机。
* 网守不应该执行任何与应用程序或服务相关的处理，也不应该访问任何数据。
  它的功能纯粹是验证和消毒请求。受信任的主机可能需要对请求执行额外的验证，
  但是核心验证应该由网守执行。
* 在可能的情况下，在网守和受信任的主机或任务之间使用安全通信通道(HTTPS、 SSL 或 TLS)。
  但是，一些宿主环境不支持内部端点上的 HTTPS。
* 向应用程序添加额外的层以实现网守模式可能会对性能产生一些影响，因为它需要额外的处理和网络通信。
* 网守实例可能是单点故障。
  为了尽量减少故障的影响，请考虑部署额外的实例并使用自动伸缩机制来确保维护可用性的能力。

# 何时使用

此模式非常有用：

* 处理敏感信息的应用程序、公开必须具有高度防范恶意攻击的服务的应用程序，
  或执行不应中断的关键任务操作的应用程序。
* 在分布式应用程序中，需要独立于主要任务执行请求验证，或者集中验证以简化维护和管理。

# 示例

在云托管场景中，可以通过将网守角色或虚拟机与应用程序中的可信角色和服务分离来实现此模式。
为此，可以使用内部端点、队列或存储作为中间通信机制。该图说明了如何使用内部端点。

![gatekeeper endpoint](/asset/img/gatekeeper-endpoint.png)

# 相关指引

在实现 Gatekeep 模式时，[ValetKey 模式](TODO: 链接到此模式)也可能是相关的。
在 Gatekeep 和受信任角色之间进行通信时，通过使用限制访问资源权限的密钥或令牌来增强安全性是一种很好的做法。该模式描述如何使用令牌或密钥，该令牌或密钥为客户机提供对特定资源或服务的受限制的直接访问。
