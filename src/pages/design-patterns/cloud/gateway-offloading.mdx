---
title: Gateway Offloading Pattern
translateFrom: https://docs.microsoft.com/en-us/azure/architecture/patterns/gateway-offloading
---

将共享或专用服务功能卸载到网关代理。
通过将共享服务功能(如 SSL 证书的使用)从应用程序的其他部分移动到网关，
这种模式可以简化应用程序开发。

# 问题背景

一些特性通常跨多个服务使用，这些特性需要配置、管理和维护。
与每个应用程序部署一起分布的共享或专用服务增加了管理开销，并增加了部署错误的可能性。
对共享特性的任何更新都必须部署在所有共享该特性的服务上。

正确处理安全问题(令牌验证、加密、 SSL 证书管理)和其他复杂任务需要团队成员具备高度专业化的技能。
例如，必须在所有应用程序实例上配置和部署应用程序所需的证书。
对于每个新的部署，必须对证书进行管理，以确保它不会过期。
必须在每个应用程序部署中更新、测试和验证任何即将过期的公共证书。

其他常见服务如身份验证、授权、日志记录、监视或节流（TODO: 链接到此模式
）可能难以在大量部署中实现和管理。
为了减少开销和发生错误的可能性，合并这种类型的功能可能更好。

# 解决方案

将一些特性卸载到网关中，特别是横切关注点，
如证书管理、身份验证、 SSL 终止、监视、协议转换或节流。

下图显示了终止入站 SSL 连接的网关。
它代表原始请求者从网关上游的任何 HTTP 服务器请求数据。

![gateway-offload](/asset/img/gateway-offload.png)

这种模式的好处包括:

* 简化服务的开发，不再需要分发和维护支持资源，例如网络服务器证书和安全网站的配置。
  更简单的配置使得管理和可伸缩性更加容易，并使得服务升级更加简单。
* 允许专门的团队实现需要专门知识的特性，比如安全性。
  这使您的核心团队能够专注于应用程序功能，将这些专门的但是跨领域的问题留给相关的专家。
* 为请求和响应日志记录和监视提供一些一致性。
  即使没有正确地检测服务，网关也可以配置为确保最低级别的监视和日志记录。

# 问题与注意事项

* 确保网关具有高可用性和对故障的弹性。通过运行网关的多个实例避免单点故障。
* 确保网关是为应用程序和端点的容量和伸缩需求而设计的。
  确保网关不会成为应用程序的瓶颈，并且具有足够的可伸缩性。
* 只卸载整个应用程序使用的特性，如安全性或数据传输。
* 永远不应该将业务逻辑卸载到网关。
* 如果需要跟踪事务，请考虑为日志记录目的生成相关 ID。

# 何时使用

在以下情况下使用这种模式:

* 应用程序部署具有共享的关注点，如 SSL 证书或加密。
* 在可能具有不同资源需求(如内存资源、存储容量或网络连接)的应用程序部署中很常见的一个特性。
* 您希望将网络安全、节流或其他网络边界问题等问题的责任移交给更专业的团队。

如果这种模式引入了跨服务的耦合，那么它可能不适合。

# 示例

使用 Nginx 作为 SSL 卸载设备，下面的配置终止入站 SSL 连接并将连接分发到三个上游 HTTP 服务器之一。

```console
upstream iis {
        server  10.3.0.10    max_fails=3    fail_timeout=15s;
        server  10.3.0.20    max_fails=3    fail_timeout=15s;
        server  10.3.0.30    max_fails=3    fail_timeout=15s;
}

server {
        listen 443;
        ssl on;
        ssl_certificate /etc/nginx/ssl/domain.cer;
        ssl_certificate_key /etc/nginx/ssl/domain.key;

        location / {
                set $targ iis;
                proxy_pass http://$targ;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto https;
proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header Host $host;
        }
}
```

