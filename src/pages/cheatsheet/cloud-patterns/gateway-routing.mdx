---
layout: ../../../layouts/MdxLayout.astro
title: Gateway Routing pattern
parent:
  name: 返回上级
  path: /cheatsheet/cloud-patterns/
translateFrom:
  url: https://learn.microsoft.com/en-us/azure/architecture/patterns/gateway-routing
  title: Gateway Routing pattern - Azure Architecture Center
---

使用单个端点将请求路由到多个服务或多个服务实例。当您需要时，该模式很有用：

- 在单个端点上公开多个服务并根据请求路由到适当的服务
- 为了负载平衡或可用性目的，在单个端点上公开同一服务的多个实例
- 在单个端点上公开同一服务的不同版本，并跨不同版本路由流量

## 问题上下文

当客户端需要使用多个服务、多个服务实例或两者的组合时，必须在添加或删除服务时更新客户端。考虑以下场景。

- 多个不同的服务——电子商务应用程序可能提供搜索、评论、购物车、结账和订单历史记录等服务。
  每个服务都有不同的API，客户端必须与之交互，客户端必须了解每个端点才能连接到服务。
  如果API发生变化，客户端也必须更新。如果您将服务重构为两个或多个独立的服务，则服务和客户端中的代码都必须更改。

- 同一服务的多个实例——系统可能需要在相同或不同的区域中运行同一服务的多个实例。
  运行多个实例可以用于负载平衡目的或满足可用性要求。每次向上或向下旋转实例以满足需求时，都必须更新客户端。

- 同一服务的多个版本——作为部署方案的一部分，服务的新版本可以与现有版本一起部署。
  这称为蓝绿色部署。在这些场景中，每次路由到新版本和现有端点的流量百分比发生变化时，都必须更新客户端。

## 解决方案

将网关放在一组应用程序、服务或部署之前。使用应用程序第7层路由将请求路由到适当的实例。 TODO: 这句话很奇怪。。

使用此模式，客户端应用程序只需了解单个端点并与单个端点通信。

### 多个不同的服务

```d2 pad=8
Consumer

Gateway

Search Service
Checkout Service
Order History Service
Cart Service
Reviews Service

Consumer -> Gateway

Gateway -> Search Service
Gateway -> Checkout Service
Gateway -> Order History Service
Gateway -> Cart Service
Gateway -> Reviews Service
```

网关路由模式在客户端使用多个服务的情况下很有用。
如果服务被合并、分解或替换，客户端不一定需要更新。它可以继续向网关发出请求，只有路由改变。

网关还允许您从客户端抽象后端服务，允许您保持客户端调用简单，同时启用网关后面后端服务的更改。
客户端调用可以路由到处理预期客户端行为所需的任何服务，允许您在网关后面添加、拆分和重组服务，而无需更改客户端。

### 同一服务的多个实例

```d2 pad=8
Consumer

Gateway

Region1 {
    Search Service
}

Region2 {
    Search Service
}

Consumer -> Gateway

Gateway -> Region1.Search Service
Gateway -> Region2.Search Service
```

弹性是云计算的关键。服务可以向上扩展以满足不断增长的需求，也可以在需求较低时向下扩展以节省资金。
注册和取消注册服务实例的复杂性封装在网关中。客户端不知道服务数量的增加或减少。

服务实例可以部署在单个或多个区域中。Geode模式详细说明了多区域、主动-主动部署如何改善延迟并提高服务的可用性。 TODO:

### 同一服务的多个版本

```d2 pad=8
Consumer

Gateway

Search Service V1

Search Service V1\.1

Consumer -> Gateway

Gateway ->  Search Service V1
Gateway ->  Search Service V1\.1
```

通过允许您管理向用户推出更新的方式，此模式可用于部署。
当部署服务的新版本时，它可以与现有版本并行部署。
路由允许您控制向客户端呈现服务的版本，使您能够灵活地使用各种发布策略，无论是增量的、并行的，还是更新的完全推出。
部署新服务后发现的任何问题都可以通过在网关处进行配置更改来快速恢复，而不会影响客户端。

## 实现考量

- 网关服务可能会引入单点故障。确保其设计正确以满足您的可用性要求。在实施中考虑弹性和容错功能。

- 网关服务可能会引入瓶颈。确保网关具有足够的性能来处理负载，并且可以根据您的增长预期轻松扩展。

- 对网关执行负载测试，以确保不会为服务引入级联故障。

- 网关路由为7级。它可以基于IP、端口、标头或URL。 TODO: 啥意思

- 网关服务可以是全局的，也可以是区域性的。Azure Front Door是全局网关，而Azure应用程序网关是区域性的。
  如果解决方案需要多区域部署服务，请使用全局网关。
  如果有需要精细控制流量平衡方式的区域性工作负载，请考虑使用应用程序网关。例如，要平衡虚拟机之间的流量。

- 网关服务是它所在服务的公共端点。考虑限制对后端服务的公共网络访问，方法是使服务只能通过网关或专用虚拟网络访问。

## 何时使用

以下场景可使用此模式：

- 客户端需要使用可以在网关后面访问的多个服务。

- 您希望通过使用单个端点来简化客户端应用程序。

- 您需要将请求从外部可寻址端点路由到内部虚拟端点，例如将VM上的端口暴露给集群虚拟IP地址。

- 客户端需要使用在多个区域运行的服务以获得延迟或可用性优势。

- 客户端需要使用可变数量的服务实例。

- 您希望实现客户端同时访问服务多个版本的部署方案。

- 当您有一个只使用一两个服务的简单应用程序时，这种模式可能不合适。