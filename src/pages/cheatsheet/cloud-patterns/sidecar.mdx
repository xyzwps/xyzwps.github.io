---
layout: ../../../layouts/MdxLayout.astro
title: Sidecar pattern
parent:
  name: 返回上级
  path: /cheatsheet/cloud-patterns/
translateFrom:
  url: https://learn.microsoft.com/en-us/azure/architecture/patterns/sidecar
  title: Sidecar pattern - Azure Architecture Center
---

TODO: 改进

将应用程序的组件部署到单独的进程或容器中，以提供隔离和封装。
这种模式还可以使应用程序由异构组件和技术组成。

这种模式之所以被命名为边车，是因为它类似于附在摩托车上的边车/挎斗。
在这种模式中，边车附在父应用程序上，并为应用程序提供支持功能。
边车也与父应用程序共享相同的生命周期，与父应用程序一起创建和退役。
边车模式有时被称为伙伴模式，是一种分解模式。

## 问题上下文

应用程序和服务通常需要相关功能，例如监控、日志记录、配置和网络服务。这些外围任务可以作为单独的组件或服务实现。

如果它们紧密集成到应用程序中，它们可以在与应用程序相同的进程中运行，有效利用共享资源。
然而，这也意味着它们没有很好地隔离，其中一个组件的中断可能会影响其他组件或整个应用程序。
此外，它们通常需要使用与父应用程序相同的语言来实现。因此，组件和应用程序彼此密切相关。

如果将应用程序分解为服务，那么可以使用不同的语言和技术构建每个服务。
虽然这提供了更大的灵活性，但这意味着每个组件都有自己的依赖关系，并且需要特定语言的库来访问底层平台以及与父应用程序共享的任何资源。
此外，将这些功能部署为单独的服务会增加应用程序的延迟。
管理这些特定语言接口的代码和依赖关系也会增加相当大的复杂性，特别是对于托管、部署和管理。

## 解决方案

将一组有凝聚力的任务与主应用程序放在一起，但将它们放在自己的进程或容器中，为跨语言的平台服务提供同质接口。

```d2 pad=16
direction: right
Host: {
    Primary Application: {
        ex: |md
            Core functionality
        |
    }
    Sidecar: {
        ex: |md
            Peripheral tasks such as:
            - Platform abstraction
            - Proxy to remote services
            - Logging
            - Configuration
        |
    }
}

Host.Primary Application <-> Host.Sidecar

```

Sidecar服务不一定是应用程序的一部分，而是连接到它。
父应用程序去哪里，它就去哪里。Sidecar支持与主应用程序一起部署的流程或服务。
在摩托车上，Sidecar连接到一辆摩托车上，每辆摩托车都可以有自己的Sidecar。
同样，Sidecar服务共享其父应用程序的命运。
对于应用程序的每个实例，Sidecar的一个实例与它一起部署和托管。

使用边车模式的优点包括：

- Sidecar在运行时环境和编程语言方面独立于其主要应用程序，因此您无需为每种语言开发一个Sidecar。

- sidecar可以访问与主应用程序相同的资源。例如，sidecar可以监控sidecar和主应用程序共同使用的系统资源。

- 由于它靠近主应用程序，因此在它们之间进行通信时没有显着的延迟。

- 即使对于不提供可扩展性机制的应用程序，您也可以使用sidecar通过将其作为自己的进程附加到与主应用程序相同的主机或子容器中来扩展功能。

Sidecar模式通常与容器一起使用，称为Sidecar容器或伙伴（sidekick）容器。

## 实现考量

- 考虑您将用于部署服务、流程或容器的部署和打包格式。容器特别适合sidecar模式。

- 在设计sidecar服务时，请仔细决定进程间通信机制。尝试使用与语言或框架无关的技术，除非性能要求使其不切实际。

- 在将功能放入sidecar之前，请考虑它作为单独的服务还是更传统的守护程序更好地工作。

- 还要考虑是否可以将功能实现为库或使用传统的扩展机制。特定语言的库可能具有更深层次的集成和更少的网络开销。

## 何时使用

以下场景可使用此模式：

- 您的主要应用程序使用一组异构的语言和框架。位于sidecar服务中的组件可以被使用不同框架以不同语言编写的应用程序使用。

- 组件由远程团队或不同的组织拥有。

- 组件或功能必须与应用程序位于同一主机上。

- 您需要一个共享主应用程序的整个生命周期但可以独立更新的服务。

- 您需要对特定资源或组件的资源限制进行细粒度控制。例如，您可能希望限制特定组件使用的内存量。
  您可以将组件部署为Sidecar并独立于主应用程序管理内存使用情况。

以下场景不适用：

- 当需要优化进程间通信时。父应用程序和sidecar服务之间的通信包括一些开销，特别是调用中的延迟。
  对于聊天接口来说，这可能不是一个可以接受的权衡。

- 对于小型应用程序，部署sidecar服务花费的资源太多，不值当的。

- 当服务需要与主要应用程序不同或独立于主要应用程序进行扩展时。如果是这样，最好将该功能部署为单独的服务。

## 示例场景

- 基础设施API。基础设施开发团队创建与每个应用程序一起部署的服务，而不是访问基础设施的特定语言客户端库。
  该服务作为sidecar加载，并为基础设施服务提供公共层，包括日志记录、环境数据、配置存储、发现、健康检查和看门狗服务。
  sidecar还监控父应用程序的主机环境和进程（或容器），并将信息记录到集中式服务中。

- 管理NGINX/HAProxy。使用监控环境状态的sidecar服务部署NGINX，然后更新NGINX配置文件并在需要更改状态时回收进程。

- 大使边车。将大使服务部署为边车。应用程序通过大使调用，大使处理请求记录、路由、断路和其他与连接相关的功能。 TODO: 

- 卸载代理。将NGINX代理放在node.js服务实例前面，以处理为服务提供静态文件内容。