---
layout: ../../../layouts/MdxLayout.astro
title: 隔板模式
parent:
  name: 返回上级
  path: /cheatsheet/cloud-patterns/
---

https://learn.microsoft.com/en-us/azure/architecture/patterns/bulkhead


**隔板**（*Bulkhead*）模式是一种可以容忍故障的应用程序设计。
在隔板架构中，也称为基于单元的架构（*cell-based architecture*），应用程序的元素被隔离到池中，
这样如果一个出现故障，其他元素将继续运行。
它以船体的分段隔板命名。如果船体受损，只有受损部分充满水，这可以防止船沉没。

## 问题上下文

一个云应用程序可能包括多个服务，每个服务都有一个或多个消费者。服务过载或故障将影响服务的所有消费者。

此外，消费者可能会同时向多个服务发送请求，每个请求都消耗资源。
当消费者向配置错误或没有响应的服务发送请求时，客户端请求使用的资源可能无法及时释放。
随着对服务的请求继续，这些资源可能会耗尽。
例如，客户端的连接池可能会耗尽。此时，消费者对其他服务的请求会受到影响。
最终消费者无法再向其他服务发送请求，而不仅仅是原来的无响应服务。

同样的资源耗尽问题会影响具有多个消费者的服务。
来自一个客户端的大量请求可能会耗尽服务中的可用资源。
其他消费者不再能够使用该服务，从而导致级联故障效应。

## 解决方案

根据消费者负载和可用性要求将服务实例划分为不同的组。
这种设计有助于隔离故障，并允许您为部分消费者维持服务功能，即使在故障期间也是如此。

消费者还可以对资源进行分区，以确保用于调用一个服务的资源不会影响用于调用另一个服务的资源。
例如，调用多个服务的消费者可能会为每个服务分配一个连接池。
如果一个服务开始失败，它只会影响为该服务分配的连接池，允许消费者继续使用其他服务。

这种模式有的好处包括：

* 将消费者和服务与级联故障隔离开来。影响消费者或服务的问题可以在其自身的隔板内隔离，从而防止整个解决方案失败。
* 允许您在服务失败时保留某些功能。应用程序的其他服务和功能将继续工作。
* 允许您在部署为不同的消费者提供不同服务质量。可以将高优先级消费者池配置为使用高优先级服务。


下图显示了围绕调用单个服务的连接池构建的隔板。
如果服务A发生故障或导致其他问题，连接池将被隔离，因此只有使用分配给服务A的线程池的工作负载会受到影响。
使用服务B和C的工作负载不受影响，并且可以继续工作而不会中断。

```d2 pad=16
grid-rows: 3

classes: {
    failed: {
        style: {
            fill: red
            font-color: white
        }
    }
    service: {
        style: {
            border-radius: 8
        }
    }
}

工作负载1.class: failed

工作负载2

连接池1.class: failed

连接池2

连接池3

服务A.class: [failed; service]

服务B.class: service

服务C.class: service

工作负载1 -> 连接池1 -> 服务A

工作负载2 -> 连接池2 -> 服务B
工作负载2 -> 连接池3 -> 服务C
```

下一个图显示了多个客户端调用单个服务。
每个客户端都被分配了一个单独的服务实例。客户端1发出了太多请求，使其实例不堪重负。
因为每个服务实例都与其他服务实例隔离，所以其他客户端可以继续进行调用。

```d2 pad=16
grid-rows: 2

classes: {
    failed: {
        style: {
            fill: red
            font-color: white
        }
    }
    service: {
        style: {
            border-radius: 8
        }
    }
}

客户端1.class: failed
客户端2
客户端3

服务A: {
    实例1.class: failed
    实例2
    实例3
}

客户端1 -> 服务A.实例1
客户端2 -> 服务A.实例2
客户端3 -> 服务A.实例3
```

## 实现考量

- 围绕应用程序的业务和技术需求定义分区。
- 如果使用战术DDD设计微服务，分区边界应与有界上下文保持一致。
- 在将服务或消费者划分为隔板时，请考虑技术提供的隔离级别以及成本、性能和可管理性方面的开销。
- 考虑将隔板与重试、断路器和节流模式相结合，以提供更复杂的故障处理。
- 将消费者划分为隔板时，请考虑使用进程、线程池和信号量。[resilience4j](https://github.com/resilience4j/resilience4j) 和
  [Polly](https://github.com/App-vNext/Polly) 等项目提供了一个创建消费者隔板的框架。
- 将服务划分为隔板时，请考虑将它们部署到单独的虚拟机、容器或进程中。容器以相当低的开销提供了资源隔离的良好平衡。
- 使用异步消息进行通信的服务可以通过不同的队列集进行隔离，每个队列上可以有一组处理消息的专用实例，也可以有一组使用算法进行出队和分派处理的实例。
- 确定隔板的颗粒度级别。例如，如果您想跨分区分配租户，您可以将每个租户放入单独的分区，或将多个租户放入一个分区。
- 监控每个分区的性能和SLA。

## 何时使用

使用此模式来：

- 隔离用于使用一组后端服务的资源，特别是如果应用程序可以提供某种级别的功能，即使其中一个服务没有响应。
- 将关键消费者与标准消费者隔离开来。
- 保护应用程序免受级联故障的影响。

此模式在以下场景不适用：

- 在项目中，资源使用效率较低可能是不可接受的。
- 增加的复杂性是不必要的。