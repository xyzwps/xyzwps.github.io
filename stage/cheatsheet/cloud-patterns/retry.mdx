---
layout: ../../../layouts/MdxLayout.astro
title: 重试模式
parent:
  name: 返回上级
  path: /cheatsheet/cloud-patterns/
translateFrom:
  url: https://learn.microsoft.com/en-us/azure/architecture/patterns/retry
  title: Retry pattern - Azure Architecture Center
---

通过透明地重试失败的操作，使应用程序在尝试连接到服务或网络资源时，能够处理暂时性故障。这可以提高应用程序的稳定性。

## 问题上下文

云上相互通信的应用，应该对环境中发生的瞬时故障敏感。
这些瞬时故障包括：服务间网络暂时丢失、服务暂时不可用、服务繁忙时超时等。

这些故障通常能自我纠正，如果触发故障的操作在适当的延迟后重复，它可能会成功。
比如，正在处理大量并发请求的数据库服务会实施[节流策略](/cheatsheet/cloud-patterns/throttling)，暂时拒绝任何进一步的请求，直到其工作负载减轻。
尝试访问数据库的应用程序可能无法连接，但如果它在延迟后再次尝试，它可能会成功。

## 解决方案

在云中，瞬态故障应该是预期的，应用程序应该设计为优雅透明地处理它们。
这样做，故障对应用程序正在执行的业务任务的影响，可以被最大限度地减少。
最常见的办法是引入重试机制。

> 由于暂时性故障是普遍的，许多客户端库和云服务现在都提供了内置的重试机制，
> 还可以配置一些参数，比如最大重试次数、重试之间的延迟等。

## 重试策略


如果应用程序在尝试向远程服务发送请求时检测到故障，它可以使用以下策略处理故障：

- **取消**（*Cancel*）：如果故障不是暂时的，或者即使重复也不太可能成功，应用程序可以取消操作并报告异常。
- **立即重试**（*Retry Immediately*）：对于一些罕见故障，比如网络数据包在传输过程中损坏，最好的作法是立即重试。
- **延迟重试**（*Retry After Delay*）：如果是更常见的连接或繁忙故障，
  网络或服务可能需要很短的时间来纠正连接问题或清除积压的工作，因此以编程方式延迟重试是一个很好的策略。
  在许多情况下，在选择重试之间的时间间隔时，应尽可能均匀地分布来自应用程序多个实例的请求，
  以减少繁忙服务继续过载的机会。

如果请求仍然失败，应用程序可以先等一会儿，然后再尝试一次。
如有必要，可以增加两次重试之间的延迟，并重复此过程，直到重试次数达到上限。
延迟可以递增或指数增加，这取决于故障的类型，和在此期间故障恢复的概率。

应用程序应该把访问远程服务的过程包在重试代码中，该代码应该选择合适的重试策略。
发送到不同服务的请求可能需要不同的策略。

应用程序应记录故障和失败操作的详细信息。这些信息对管理员很有用。
话虽如此，为了避免操作员被随后重试尝试成功的操作警报淹没，最好将早期失败记录为信息条目，
并且仅将最后一次重试尝试的失败记录为实际错误。

如果服务经常繁忙甚至不可用，通常是因为服务已经耗尽了资源。
您可以通过横向扩展服务来降低这些故障的频率。例如，如果数据库服务持续过载，
将数据库分区并将负载分散到多个服务器可能是有益的。

## 实现考量

在实现此模式时，你应该考虑以下因素：

### 对性能的影响

应该对重试策略进行调整，以匹配应用程序的业务需求和故障的性质。
对于一些非关键操作，最好快速失败，而不是多次重试并影响应用程序的吞吐量。
例如，在访问远程服务的交互式Web应用程序中，最好在重试次数较少后失败，
重试尝试之间只有很短的延迟，并向用户显示合适的消息（例如，“请稍后再试”）。
对于批处理应用程序，在尝试之间的延迟呈指数增长的情况下增加重试尝试的次数可能更合适。

积极的重试策略，尝试之间的延迟最小，以及大量重试，可能会使已经接近饱和的服务更加饱和。
如果应用程序不断尝试执行失败的操作，此重试策略还可能影响应用程序的响应能力。

如果请求在大量重试后仍然失败，应用程序最好防止进一步的请求进入同一资源，并立即报告失败。
当期限到期时，应用程序可以暂时允许一个或多个请求通过，以查看它们是否成功。
请参照[断路器模式](/cheatsheet/cloud-patterns/circuit-breaker)。

### 幂等性

考虑操作是否是幂等的。如果是这样，重试本质上是安全的。
否则，重试可能会导致操作执行多次，并产生意想不到的副作用。
例如，服务可能会出现收到并成功处理请求，但无法发送响应的情况。
此时，重试逻辑可能会重新发送请求，假设没有收到第一个请求。

### 异常类型

请求失败的原因多种多样，根据失败的性质会引发不同的异常。
一些异常表示可以快速解决的故障，而另一些则表示故障持续时间更长。
重试策略可以根据异常的类型调整重试尝试之间的时间间隔。

### 事务一致性

应该考虑重试作为事务一部分的操作将如何影响整体事务一致性。
微调事务操作的重试策略，以最大限度地提高成功机会并减少撤消所有事务步骤的需要。

## 通用建议

- 确保所有重试代码都针对各种故障条件进行了全面测试。
  检查它是否不会严重影响应用程序的性能和可靠性，不会对服务和资源造成过度负载，或者产生竞争条件或瓶颈。
- 仅在理解了失败操作的完整上下文时才重试。
  例如，如果一个包含重试策略的任务调用另一个也包含重试策略的任务，那么这个额外的重试层可能会给处理增加长时间的延迟。
  最好将较低级别的任务配置为快速失败，并将失败原因报告给调用它的任务。
  然后，这个较高级别的任务可以根据自己的策略处理失败。
- 记录所有导致重试的连接故障，以便可以识别应用程序、服务或资源的潜在问题。
- 对服务或资源最有可能发生的故障进行调查，以发现它们是否可能是长期故障或终结故障。
  如果是，最好将故障作为异常处理。应用程序可以报告或记录异常，然后尝试通过调用替代服务（如果可用）或提供降级功能来继续。
  有关如何检测和处理长期故障的更多信息，请参阅[断路器模式](/cheatsheet/cloud-patterns/circuit-breaker)。

## 何时使用

当应用程序在与远程服务交互或访问远程资源时可能遇到短暂故障时，请使用此模式。
这些故障预计是短暂的，重复以前失败的请求可能会在后续尝试中成功。

以下场景可能不适用：

* 如果故障持续很长时间，就会影响应用程序的响应能力。应用程序可能会浪费时间和资源来尝试重复可能失败的请求。
* 处理不是由瞬态故障引起的故障，例如由应用程序业务逻辑中的错误引起的内部异常。
* 用作解决系统中可扩展性问题的替代方案。如果应用程序遇到频繁的繁忙故障，这通常表明应该扩展正在访问的服务或资源。