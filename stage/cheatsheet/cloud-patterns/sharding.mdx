---
layout: ../../../layouts/MdxLayout.astro
title: Sharding pattern
parent:
  name: 返回上级
  path: /cheatsheet/cloud-patterns/
translateFrom:
  url: https://learn.microsoft.com/en-us/azure/architecture/patterns/sharding
  title: Sharding pattern - Azure Architecture Center
---

TODO: 翻译很烂

将数据存储划分为一组水平分区或分片。这可以提高存储和访问大量数据时的可扩展性。

## 问题上下文

由单个服务器托管的数据存储可能受到以下限制：

- 存储空间。大型云应用程序的数据存储预计包含大量数据，这些数据可能会随着时间的推移而显着增加。
  服务器通常只提供有限数量的磁盘存储，但您可以用更大的磁盘替换现有磁盘，或者随着数据量的增长向机器添加更多磁盘。
  然而，系统最终会达到一个限制，即无法轻松增加给定服务器上的存储容量。

- 计算资源。云应用程序需要支持大量并发用户，每个用户都运行从数据存储中检索信息的查询。
  托管数据存储的单个服务器可能无法提供必要的计算能力来支持这种负载，导致用户响应时间延长，应用程序尝试存储和检索数据超时时频繁失败。
  添加内存或升级处理器可能是可能的，但是当不可能进一步增加计算资源时，系统将达到极限。

- 网络带宽。最终，在单个服务器上运行的数据存储的性能取决于服务器接收请求和发送回复的速率。
  流量可能超过用于连接服务器的网络容量，从而导致请求失败。

- 地理。出于法律、合规性或性能原因，或为了减少数据访问的延迟，可能有必要将特定用户生成的数据存储在同一区域。
  如果用户分散在不同的国家或地区，则可能无法将应用程序的整个数据存储在单个数据存储中。

通过增加更多磁盘容量、处理能力、内存和网络连接来垂直扩展可以推迟其中一些限制的影响，但这可能只是一个临时解决方案。
能够支持大量用户和大量数据的商业云应用程序必须能够几乎无限地扩展，因此垂直扩容不一定是最好的解决方案。

## 解决方案

将数据存储划分为水平分区或分片。每个分片具有相同的模式，但包含自己不同的数据子集。
分片本身就是一个数据存储（它可以包含许多不同类型实体的数据），在充当存储节点的服务器上运行。

这种模式有以下好处：

- 您可以通过添加在其他存储节点上运行的更多分片来横向扩展系统。

- 系统可以为每个存储节点使用现成的硬件，而不是专门且昂贵的计算机。

- 您可以通过平衡分片之间的工作负载来减少争用并提高性能。

- 在云中，分片可以在物理上靠近将访问数据的用户。

当将数据存储划分为分片时，决定哪些数据应该放在每个分片中。分片通常包含属于由数据的一个或多个属性确定的指定范围内的项目。
这些属性形成分片键（有时称为分区键）。分片键应该是静态的。它不应该基于可能发生变化的数据。

分片物理地组织数据。当应用程序存储和检索数据时，分片逻辑将应用程序定向到适当的分片。
这种分片逻辑可以作为应用程序中数据访问代码的一部分来实现，或者如果它透明地支持分片，它可以由数据存储系统来实现。

在分片逻辑中抽象数据的物理位置提供了对哪些分片包含哪些数据的高度控制。
如果分片中的数据需要稍后重新分配（例如，如果分片变得不平衡），它还使数据能够在分片之间迁移，而无需修改应用程序的业务逻辑。
权衡是在确定检索到的每个数据项的位置时所需的额外数据访问开销。

为了确保最佳性能和可伸缩性，以适合应用程序执行的查询类型的方式拆分数据非常重要。
在许多情况下，分片方案不太可能完全匹配每个查询的要求。
例如，在多租户系统中，应用程序可能需要使用租户ID检索租户数据，但它可能还需要根据租户名称或位置等其他属性查找此数据。
要处理这些情况，请使用支持最常用查询的分片键实现分片策略。

如果查询使用属性值的组合定期检索数据，您可以通过将属性链接在一起来定义复合分片键。
或者，使用索引表等模式根据分片键未涵盖的属性提供对数据的快速查找。

## 分片策略

在选择分片键和决定如何跨分片分发数据时，通常使用三种策略。
请注意，分片和托管它们的服务器之间不必一一对应——单个服务器可以托管多个分片。策略是：

**查找策略**。在此策略中，分片逻辑实现了一个映射，该映射使用分片键将数据请求路由到包含该数据的分片。
在多租户应用程序中，租户的所有数据可能使用租户ID作为分片键一起存储在分片中。
多个租户可能共享同一个分片，但单个租户的数据不会分布在多个分片中。该图说明了基于租户ID分片租户数据。

![](https://learn.microsoft.com/en-us/azure/architecture/patterns/_images/sharding-tenant.png)

分片键值和数据所在的物理存储之间的映射可以基于物理分片，其中每个分片键值映射到物理分区。
或者，重新平衡分片的一种更灵活的技术是虚拟分区，其中分片键值映射到相同数量的虚拟分片，这反过来又映射到更少的物理分区。
在这种方法中，应用程序使用引用虚拟分片的分片键值来定位数据，系统透明地将虚拟分片映射到物理分区。
虚拟分片和物理分区之间的映射可以更改，而无需修改应用程序代码以使用不同的分片键值集。

**Range策略**。该策略将相关项目组合在同一个分片中，并按分片键排序——分片键是顺序的。
对于经常使用范围查询（返回属于给定范围的分片键的一组数据项的查询）检索项目集的应用程序来说，它很有用。
例如，如果应用程序经常需要查找给定月份下的所有订单，如果一个月的所有订单都按日期和时间顺序存储在同一个分片中，则可以更快地检索这些数据。
如果每个订单存储在不同的分片中，则必须通过执行大量点查询（返回单个数据项的查询）来单独获取它们。

![](https://learn.microsoft.com/en-us/azure/architecture/patterns/_images/sharding-sequential-sets.png)

在此示例中，分片键是一个复合键，其中包含订单月份作为最重要的元素，然后是订单日期和时间。
当创建新订单并将其添加到分片时，订单的数据会自然排序。
一些数据存储支持由两部分组成的分片键，其中包含一个标识分片的分区键元素和一个唯一标识分片中项目的行键。
数据通常在分片中按行键顺序保存。受到范围查询并且需要组合在一起的项目可以使用分片键，该分片键具有与分区键相同的值，但行键具有唯一值。

**哈希策略**。该策略的目的是减少热点（接收不成比例负载量的分片）的机会。
它以在每个分片的大小和每个分片将遇到的平均负载之间取得平衡的方式将数据分布在分片上。
分片逻辑根据数据的一个或多个属性的哈希计算分片以存储项目。
所选择的哈希函数应该在分片上均匀分布数据，可能是通过在计算中引入一些随机元素。下一个图说明了基于租户ID的哈希来分片租户数据。

![](https://learn.microsoft.com/en-us/azure/architecture/patterns/_images/sharding-data-hash.png)

要了解Hash策略相对于其他分片策略的优势，请考虑顺序注册新租户的多租户应用程序如何将租户分配到数据存储中的分片。
使用Range策略时，租户1到n的数据将全部存储在分片A中，租户n+1到m的数据将全部存储在分片B中，依此类推。
如果最近注册的租户也是最活跃的，大多数数据活动将发生在少数分片中，这可能会导致热点。
相比之下，哈希策略根据租户ID的哈希将租户分配到分片。这意味着顺序租户最有可能被分配到不同的分片，这将在它们之间分配负载。

三种分片策略具有以下优点和考虑：

- 查找。这提供了对分片配置和使用方式的更多控制。使用虚拟分片可以减少重新平衡数据时的影响，因为可以添加新的物理分区来平衡工作负载。
  可以修改虚拟分片和实现分片的物理分区之间的映射，而不会影响使用分片键存储和检索数据的应用程序代码。查找分片位置会增加额外的开销。

- 范围。这很容易实现，并且适用于范围查询，因为它们通常可以在单个操作中从单个分片中获取多个数据项。这种策略提供了更容易的数据管理。
  例如，如果同一区域的用户在同一个分片中，则可以根据本地负载和需求模式在每个时区安排更新。但是，这种策略不能提供分片之间的最佳平衡。
  如果大部分活动都用于相邻的分片键，重新平衡分片很困难，并且可能无法解决负载不均匀的问题。

- 哈希。这种策略提供了更均匀的数据和负载分布的更好机会。请求路由可以直接使用哈希函数来完成。
  不需要维护地图。请注意，计算哈希可能会带来额外的开销。此外，重新平衡分片很困难。

最常见的分片系统实现了上述方法之一，但您还应该考虑应用程序的业务需求及其数据使用模式。例如，在多租户应用程序中：

- 您可以根据工作负载对数据进行分片。您可以在单独的分片中为高度不稳定的租户隔离数据。结果可能会提高其他租户的数据访问速度。

- 您可以根据租户的位置对数据进行分片。您可以将特定地理区域中租户的数据脱机，以便在该区域的非高峰时间进行备份和维护，而其他区域中租户的数据在工作时间保持在线并可访问。

- 高价值租户可以分配他们自己的私有、高性能、轻载分片，而低价值租户可能会共享更密集、更繁忙的分片。

- 需要高度数据隔离和隐私的租户的数据可以存储在完全独立的服务器上。

## 缩放和数据移动操作

每种分片策略都意味着不同的能力和复杂程度，用于管理横向扩展、数据移动和维护状态。

Lookup策略允许在用户级别（在线或离线）执行扩展和数据移动操作。
该技术是暂停部分或全部用户活动（可能在非高峰期），将数据移动到新的虚拟分区或物理分片，更改映射，
使保存此数据的任何缓存无效或刷新，然后允许用户活动恢复。通常这种类型的操作可以集中管理。
Lookup策略要求状态具有高度可缓存性和副本友好性。

Range策略对缩放和数据移动操作施加了一些限制，这些操作通常必须在部分或全部数据存储脱机时执行，因为数据必须在分片之间拆分和合并。
如果大部分活动是针对同一范围内的相邻分片键或数据标识符，则移动数据以重新平衡分片可能无法解决负载不均匀的问题。
Range策略还可能需要维护一些状态，以便将范围映射到物理分区。

哈希策略使缩放和数据移动操作更加复杂，因为分区键是分片键或数据标识符的哈希。
每个分片的新位置必须由哈希函数确定，或者修改函数以提供正确的映射。但是，哈希策略不需要维护状态。

## 实现考量

在决定如何实现此模式时，请考虑以下几点：

- 分片是对其他形式的分区的补充，例如垂直分区和功能分区。
  例如，单个分片可以包含已垂直分区的实体，一个功能分区可以实现为多个分片。有关分区的更多信息，请参阅数据分区指南。
  https://learn.microsoft.com/en-us/previous-versions/msp-n-p/dn589795(v=pandp.10)

- 保持分片平衡，以便它们都处理相同数量的I/O。随着数据的插入和删除，有必要定期重新平衡分片，以保证均匀分布并减少热点的机会。
  重新平衡可能是一项昂贵的操作。为了减少重新平衡的必要性，请通过确保每个分片包含足够的可用空间来处理预期的更改量来计划增长。
  如果有必要，您还应该开发策略和脚本来快速重新平衡分片。

- 为分片键使用稳定的数据。如果分片键发生变化，相应的数据项可能必须在分片之间移动，增加更新操作执行的工作量。
  因此，避免将分片键基于潜在的不稳定信息。相反，寻找不变或自然形成键的属性。

- 确保分片键是唯一的。例如，避免使用自动递增字段作为分片键。
  在某些系统中，自动递增字段无法跨分片协调，可能导致不同分片中的项目具有相同的分片键。

  > 非分片键的其他字段中的自动递增值也会导致问题。例如，如果您使用自动递增字段生成唯一ID，则位于不同分片中的两个不同项目可能会被分配相同的ID。

- 可能无法设计与针对数据的每个可能查询的要求相匹配的分片键。对数据进行分片以支持最频繁执行的查询，
  并在必要时创建辅助索引表以支持使用基于不属于分片键的属性的条件检索数据的查询。有关详细信息，请参阅索引表模式。 TODO:

- 仅访问单个分片的查询比从多个分片检索数据的查询效率更高，因此避免实施分片系统，
  因为分片系统会导致应用程序执行大量查询，将不同分片中保存的数据连接起来。
  请记住，单个分片可以包含多种类型实体的数据。考虑对数据进行非规范化，
  以将通常一起查询的相关实体（例如客户的详细信息和他们下的订单）保留在同一分片中，以减少应用程序执行的单独读取次数。

  > 如果一个分片中的实体引用存储在另一个分片中的实体，请将第二个实体的分片键作为第一个实体架构的一部分包含在内。
  > 这有助于提高跨分片引用相关数据的查询的性能。

- 如果应用程序必须执行从多个分片中检索数据的查询，则可以使用并行任务来获取这些数据。
  示例包括扇出查询，其中来自多个分片的数据被并行检索，然后聚合为单个结果。然而，这种方法不可避免地增加了解决方案的数据访问逻辑的复杂性。

- 对于许多应用程序，创建大量的小分片可能比拥有少量的大分片更有效，因为它们可以提供更多的负载平衡机会。
  如果您预计需要将分片从一个物理位置迁移到另一个物理位置，这也很有用。移动小分片比移动大分片更快。

- 确保每个分片存储节点可用的资源足以处理数据大小和吞吐量方面的可伸缩性要求。
  有关详细信息，请参阅数据分区指南中的“为可伸缩性设计分区”部分。
  https://learn.microsoft.com/en-us/previous-versions/msp-n-p/dn589795(v=pandp.10)

- 考虑将引用数据复制到所有分片。如果从分片中检索数据的操作也将静态或缓慢移动的数据作为同一查询的一部分引用，请将此数据添加到分片中。
  然后，应用程序可以轻松获取查询的所有数据，而无需额外往返于单独的数据存储。

  > 如果保存在多个分片中的引用数据发生更改，系统必须在所有分片中同步这些更改。
  > 当这种同步发生时，系统可能会遇到一定程度的不一致。如果您这样做，您应该设计您的应用程序以能够处理它。

- 保持分片之间的引用完整性和一致性可能很困难，因此您应该尽量减少影响多个分片中数据的操作。
  如果应用程序必须跨分片修改数据，请评估是否实际需要完整的数据展示一致性。
  相反，云中常见的方法是实现最终一致性。每个分区中的数据都单独更新，应用程序逻辑必须负责确保更新全部成功完成，
  以及处理在运行最终一致的操作时查询数据可能产生的不一致。有关实现最终一致性的更多信息，请参阅数据一致性入门。

- 配置和管理大量分片可能是一个挑战。监视、备份、检查一致性、日志记录或审计等任务必须在多个分片和服务器上完成，可能保存在多个位置。
  这些任务可能使用脚本或其他自动化解决方案来实现，但这可能不会完全消除额外的管理要求。

- 可以对分片进行地理定位，以便它们包含的数据靠近使用它的应用程序的实例。
  这种方法可以显着提高性能，但需要额外考虑必须访问不同位置的多个分片的任务。

## 何时使用

当数据存储可能需要扩展到单个存储节点可用的资源之外，或者通过减少数据存储中的争用来提高性能时，请使用此模式。

分片的主要重点是提高系统的性能和可伸缩性，但作为副产品，由于数据如何划分为单独的分区，它也可以提高可用性。
一个分区中的故障不一定会阻止应用程序访问保存在其他分区中的数据，操作员可以对一个或多个分区进行维护或恢复，而不会使应用程序的整个数据无法访问。
有关详细信息，请参阅数据分区指南。

## 参考

https://www.singlestore.com/blog/database-sharding-vs-partitioning-whats-the-difference/

https://systemdesignschool.io/blog/sharding-vs-partitioning