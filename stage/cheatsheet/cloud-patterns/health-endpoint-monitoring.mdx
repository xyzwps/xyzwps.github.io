---
layout: ../../../layouts/MdxLayout.astro
title: Health Endpoint Monitoring pattern
parent:
  name: 返回上级
  path: /cheatsheet/cloud-patterns/
translateFrom:
  url: https://learn.microsoft.com/en-us/azure/architecture/patterns/health-endpoint-monitoring
  title: Health Endpoint Monitoring pattern - Azure Architecture Center
---

TODO: 翻译很烂

要验证应用程序和服务是否正常运行，可以使用运行状况端点监控模式。
此模式指定在应用程序中使用功能检查。外部工具可以通过公开的端点定期访问这些检查。

## 问题上下文

监控Web应用程序和后端服务是一种很好的做法。监控有助于确保应用程序和服务可用并正确执行。业务需求通常包括监控。

有时监控云服务比本地服务更困难。一个原因是您无法完全控制托管环境。另一个原因是这些服务通常依赖于平台供应商和其他人提供的其他服务。

许多因素会影响云托管应用程序。示例包括网络延迟、底层计算和存储系统的性能和可用性，以及它们之间的网络带宽。
由于这些因素中的任何一个，服务都可能完全或部分失败。为确保所需的可用性级别，您必须定期验证您的服务是否正确执行。
您的服务级别协议（SLA）可能会指定您需要满足的级别。

## 解决方案

通过向应用程序上的端点发送请求来实施运行状况监控。应用程序应执行必要的检查，然后返回其状态的指示。

健康监测检查通常结合两个因素：

- 应用程序或服务响应对运行状况验证终结点的请求而执行的检查（如果有）

- 执行健康验证检查的工具或框架对结果的分析

响应代码指示应用程序的状态。可选地，响应代码还提供应用程序使用的组件和服务的状态。监控工具或框架执行延迟或响应时间检查。

下图提供了该模式的概述。

![](https://learn.microsoft.com/en-us/azure/architecture/patterns/_images/health-endpoint-monitoring-pattern.png)

应用程序中的健康监控代码也可能运行其他检查以确定：

- 云存储或数据库的可用性和响应时间。
- 应用程序使用的其他资源或服务的状态。这些资源和服务可能在应用程序中或在应用程序之外。

通过向一组可配置的端点提交请求来监控Web应用程序的服务和工具可用。
然后，这些服务和工具根据一组可配置的规则评估结果。
创建服务端点的唯一目的是在系统上执行一些功能测试相对容易。

监控工具执行的典型检查包括：

- 验证响应代码。例如，HTTP响应为200（OK）表示应用程序响应没有错误。监控系统还可能检查其他响应代码以提供更全面的结果。

- 检查响应的内容以检测错误，即使状态代码为200（OK）。通过检查内容，您可以检测仅影响返回网页或服务响应的一部分的错误。
  例如，您可以检查页面标题或查找指示应用程序返回正确页面的特定短语。

- 测量响应时间。该值包括网络延迟和应用程序发出请求所需的时间。不断增加的值可以表示应用程序或网络出现了新问题。

- 检查位于应用程序外部的资源或服务。例如，应用程序用于从全局缓存交付内容的内容交付网络。

- 检查TLS证书是否过期。

- 测量应用程序URL的DNS查找的响应时间。此检查测量DNS延迟和DNS故障。

- 验证DNS查找返回的URL。通过验证，您可以确保条目正确。您还可以帮助防止在DNS服务器受到攻击后可能导致的恶意请求重定向。

在可能的情况下，从不同的本地或托管位置运行这些检查，然后比较响应时间也很有用。理想情况下，您应该从靠近客户的位置监控应用程序。
然后，您可以准确地查看每个位置的性能。这种做法提供了更强大的检查机制。结果还可以帮助您做出以下决策：

- 在哪里部署您的应用程序
- 是否将其部署在多个数据中心

为确保您的应用程序对所有客户正常工作，请针对客户使用的所有服务实例运行测试。
例如，如果客户存储分布在多个存储帐户中，则监控过程应检查每个帐户。

## 实现考量

当您决定如何实现此模式时，请考虑以下几点：

- 考虑如何验证响应。例如，确定200（OK）状态码是否足以验证应用程序是否正常工作。检查状态码是此模式的最低实现。
  状态码提供了应用程序可用性的基本度量。但是代码提供的关于应用程序中的操作、趋势和可能即将出现的问题的信息很少。

- 确定应用程序要公开的端点数量。一种方法是为应用程序使用的核心服务公开至少一个端点，为低优先级服务公开另一个端点。
  使用这种方法，您可以为每个监控结果分配不同级别的重要性。还可以考虑公开额外的端点。
  您可以为每个核心服务公开一个端点，以增加监控颗粒度。例如，健康验证检查可能会检查应用程序使用的数据库、存储和外部地理编码服务。
  每个都可能需要不同级别的正常运行时间和响应时间。地理编码服务或其他后台任务可能会在几分钟内不可用。但应用程序可能仍然健康。

- 决定是否使用相同的端点进行监控和常规访问。您可以对两者使用相同的端点，但为健康验证检查设计特定的路径。
  例如，您可以在常规访问端点上使用 /health。使用这种方法，监控工具可以在应用程序中运行一些功能测试。
  示例包括注册新用户、登录和下测试订单。同时，您还可以验证常规访问端点是否可用。

- 确定响应监视请求在服务中收集的信息类型。您还需要确定如何返回此信息。
  大多数现有工具和框架只查看端点返回的HTTP状态代码。要返回和验证其他信息，您可能必须创建自定义监视实用程序或服务。

- 弄清楚要收集多少信息。在检查期间执行过多的处理可能会使应用程序过载并影响其他用户。
  流转时长也可能超过监控系统的超时时间。因此，系统可能会将应用程序标记为不可用。
  大多数应用程序包括诸如错误处理程序和性能计数器之类的检测。这些工具可以记录性能和详细的错误信息，这可能就足够了。
  考虑使用此数据，而不是从健康验证检查中返回其他信息。

- 考虑缓存端点状态。经常运行健康检查可能很昂贵。例如，如果通过仪表板报告健康状态，您不希望仪表板的每个请求都触发健康检查。
  相反，定期检查系统健康状况，并缓存状态。公开返回缓存状态的端点。

- 计划如何为监控端点配置安全性。通过配置安全性，您可以帮助保护端点免受公共访问，这可能：
  * 使应用程序暴露于恶意攻击。
  * 冒着敏感信息泄露的风险。
  * 吸引拒绝服务（DoS）攻击。

  通常，您在应用程序配置中配置安全性。然后，您可以轻松更新设置，而无需重新启动应用程序。考虑使用以下一种或多种技术：

  - 通过要求身份验证来保护终结点。如果监控服务或工具支持身份验证，则可以在请求标头中使用身份验证安全密钥。
    还可以随请求传递凭据。使用身份验证时，请考虑如何访问运行状况检查终结点。
    例如，Azure应用服务具有内置的运行状况检查，该检查与应用服务身份验证和授权功能集成。

  - 使用模糊或隐藏的端点。例如，在与默认应用程序URL使用的IP地址不同的IP地址上公开端点。在非标准HTTP端口上配置端点。
    此外，考虑使用测试页面的复杂路径。您通常可以在应用程序配置中指定额外的端点地址和端口。
    如有必要，您可以将这些端点的条目添加到DNS服务器。然后您可以避免直接指定IP地址。

  - 在接受诸如键值或操作模式值等参数的端点上公开方法。当请求到达时，代码可以运行依赖于参数值的特定测试。
    如果代码无法识别参数值，则可能返回404（未找到）错误。使在应用程序配置中定义参数值成为可能。

  - 使用单独的端点，在不影响应用程序操作的情况下执行基本功能测试。
    使用这种方法，您可以帮助减少DoS攻击的影响。理想情况下，避免使用可能暴露敏感信息的测试。
    有时您必须返回可能对攻击者有用的信息。在这种情况下，请考虑如何保护端点和数据免受未经授权的访问。
    依靠默默无闻是不够的。还可以考虑使用HTTPS连接并加密敏感数据，尽管这种方法会增加服务器上的负载。

- 决定如何确保监控代理正确执行。一种方法是公开一个端点，该端点从应用程序配置中返回一个值或一个可用于测试代理的随机值。
  还要确保监控系统对自身执行检查。您可以使用自检或内置测试来防止监控系统发出误报结果。

## 何时使用

此模式适用于以下场景：

- 监控网站和Web应用程序以验证可用性。
- 监控网站和Web应用程序以检查正确操作。
- 监控中间层或共享服务，以检测和隔离可能破坏其他应用程序的故障。
- 补充应用程序中的现有检测，例如性能计数器和错误处理程序。健康验证检查不能取代应用程序对日志记录和审计的要求。
  检测可以为监控计数器和错误日志以检测故障或其他问题的现有框架提供有价值的信息。但是如果应用程序不可用，检测不能提供信息。