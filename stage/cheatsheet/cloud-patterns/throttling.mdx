---
layout: ../../../layouts/MdxLayout.astro
title: 节流模式
parent:
  name: 返回上级
  path: /cheatsheet/cloud-patterns/
translateFrom:
  url: https://learn.microsoft.com/en-us/azure/architecture/patterns/throttling
  title: Throttling pattern - Azure Architecture Center
---

控制应用程序实例、单个租户或整个服务使用的资源消耗。这可以允许系统继续运行并满足服务级别协议，即使需求的增加对资源造成了极大的负担。

## 问题上下文

云应用程序的负载通常会随着时间的推移而变化，具体取决于活跃用户的数量，或他们正在执行的活动类型。
比如，更多的用户可能会在工作时间活跃，或者系统可能需要在每个月底执行计算成本高昂的分析。
活动中也可能会出现突然和意想不到的高负载。如果系统的处理需求超过了可用资源的容量，它的性能就可能会降低，甚至可能失败。
如果系统必须满足约定的服务水平，这种故障可能是不可接受的。


根据应用程序的业务目标，有许多策略可用于处理云中的不同负载。
一种策略是使用自动缩放在任何给定时间将预配资源与用户需求相匹配。
这有可能始终如一地满足用户需求，同时优化运行成本。
然而，虽然自动缩放可以触发更多资源的配置，但这种配置并不是立即的。
如果需求快速增长，可能会有一个资源短缺的时间窗口。

## 解决方案

自动缩放的另一种策略是允许应用程序仅在一定限度内使用资源，然后在达到该限度时限制它们。
系统应该监控它如何使用资源，以便当使用量超过阈值时，它可以限制来自一个或多个用户的请求。
这使系统能够继续运行，并满足现有的任何服务水平协议（SLA）。


该系统可以实施多种节流策略，包括：

- 拒绝在给定时间段内每秒访问系统API超过 n 次的单个用户的请求。
  这需要系统计量运行应用程序的每个租户或用户的资源使用情况。

- 禁用或降级非关键服务的功能，以使关键服务在运行时有足够的资源。
  比如，如果应用程序正在流式传输视频输出，它可以切换到较低的分辨率。

- 使用负载均衡来平滑活动量（TODO: 基于队列的负载均衡模式更详细地介绍了这种方法）。
  在多租户环境中，这种方法将降低每个租户的性能。
  如果系统必须支持具有不同SLA的租户的混合，高价值租户的工作可能会立即执行。
  可以推迟对其他租户的请求，并在积压缓解后进行处理。
  优先级队列模式可用于帮助实现这种方法，也可以为不同的服务级别/优先级公开不同的端点。

- 推迟低优先级的应用程序或租户正在执行的操作。这些操作可以暂停或限制，生成异常以通知租户系统繁忙，稍后应重试该操作。

- 集成可能不可用的，或返回错误的第三方服务时，应小心。
  减少正在处理的并发请求的数量，这样日志就不会不必要地充满错误。
  如果第三方服务失败，还可以尝试避免不必要的重试成本。
  然后，当请求成功处理时，返回常规的不受限制的请求处理。

自动缩放和节流方法也可以结合起来，以帮助保持应用程序的响应速度并在SLA内。
如果预计需求仍然很高，节流可以在系统扩展时提供临时解决方案。此时，可以恢复系统的全部功能。

## 实现考量

实现此模式时，应考虑以下几点：

- 对应用程序节流，是一个影响系统整个设计的架构决策。
  应在应用程序设计过程的早期考虑限制，因为一旦系统实现，就不容易添加。

- 节流必须迅速进行。系统必须能够检测到活动的增加并做出相应的反应。
  负载减轻后，系统还必须能够迅速恢复到原始状态。这需要持续捕获和监控合适的性能数据。

- 如果服务需要暂时拒绝用户请求，它应该返回特定的错误代码，如
  429（“Too Many Requests”）和 03（“Server Too Busy”），
  以便客户端应用程序可以理解拒绝提供请求的原因是由于限制。

  * HTTP 429 表示调用应用程序在一个时间窗口内发送了太多请求并超过了预定限制。
  * HTTP 503 表示服务尚未准备好处理请求。常见原因是服务遇到的临时负载峰值比预期的要多。

  客户端应用程序可以在重试请求之前等待一段时间。响应应包含 `Retry-After` HTTP 头，以支持客户端选择重试策略。

- 当系统自动缩放时，节流可以用作临时措施。
  在某些情况下，如果活动的突然暴增并且预计不会持续很长时间，那么最好简单地节流，而不是缩放，因为缩放会大大增加运行成本。

- 如果在系统自动缩放时使用节流作为临时措施，并且资源需求增长非常快，系统可能无法继续运行——即使在节流模式下运行。
  如果这是不可接受的，请考虑保持更大的容量储备并配置更积极的自动缩放。

- 规范化不同操作的资源成本，因为它们通常不包含相等的执行成本。
  例如，读操作的限制可能较低，写操作的限制可能较高。不考虑操作成本可能会导致容量耗尽，并暴露潜在的攻击媒介。

- 如果在运行时动态修改限制行为的配置，那自然是极好的。
  如果系统面临当前配置无法处理的异常负载，则可能需要增加或减少限制以稳定系统并跟上当前流量。
  此时不需要昂贵、有风险的且缓慢的部署。
  使用 TODO: 外部配置存储模式，把节流配置外部化，无需部署即可更改和应用。

## 何时使用

以下场景可以使用：

- 确保系统继续满足 SLA。
- 防止单个租户消耗应用程序提供的资源。
- 处理活动中的突发事件。
- 通过限制资源最大使用水平来优化系统成本。